{"ast":null,"code":"import { __assign, __extends } from \"tslib\";\nimport colorUtil from '@antv/color-util';\nimport { createDom, modifyCSS } from '@antv/dom-util';\nimport { each, hasKey, isElement, substitute } from '@antv/util';\nimport HtmlComponent from '../abstract/html-component';\nimport { clearDom, regionToBBox, toPx } from '../util/util';\nimport * as CssConst from './css-const';\nimport TooltipTheme from './html-theme';\nimport { getAlignPoint } from '../util/align';\nfunction hasOneKey(obj, keys) {\n  var result = false;\n  each(keys, function (key) {\n    if (hasKey(obj, key)) {\n      result = true;\n      return false;\n    }\n  });\n  return result;\n}\nvar Tooltip = /** @class */function (_super) {\n  __extends(Tooltip, _super);\n  function Tooltip() {\n    return _super !== null && _super.apply(this, arguments) || this;\n  }\n  Tooltip.prototype.getDefaultCfg = function () {\n    var cfg = _super.prototype.getDefaultCfg.call(this);\n    return __assign(__assign({}, cfg), {\n      name: 'tooltip',\n      type: 'html',\n      x: 0,\n      y: 0,\n      items: [],\n      customContent: null,\n      containerTpl: \"<div class=\\\"\" + CssConst.CONTAINER_CLASS + \"\\\"><div class=\\\"\" + CssConst.TITLE_CLASS + \"\\\"></div><ul class=\\\"\" + CssConst.LIST_CLASS + \"\\\"></ul></div>\",\n      itemTpl: \"<li class=\\\"\" + CssConst.LIST_ITEM_CLASS + \"\\\" data-index={index}>\\n          <span class=\\\"\" + CssConst.MARKER_CLASS + \"\\\" style=\\\"background:{color}\\\"></span>\\n          <span class=\\\"\" + CssConst.NAME_CLASS + \"\\\">{name}</span>:\\n          <span class=\\\"\" + CssConst.VALUE_CLASS + \"\\\">{value}</span>\\n        </li>\",\n      xCrosshairTpl: \"<div class=\\\"\" + CssConst.CROSSHAIR_X + \"\\\"></div>\",\n      yCrosshairTpl: \"<div class=\\\"\" + CssConst.CROSSHAIR_Y + \"\\\"></div>\",\n      title: null,\n      showTitle: true,\n      /**\n       * tooltip 限制的区域\n       * @type {Region}\n       */\n      region: null,\n      // crosshair 的限制区域\n      crosshairsRegion: null,\n      containerClassName: CssConst.CONTAINER_CLASS,\n      // x, y, xy\n      crosshairs: null,\n      offset: 10,\n      position: 'right',\n      domStyles: null,\n      defaultStyles: TooltipTheme\n    });\n  };\n  // tooltip 渲染时，渲染 title，items 和 corosshairs\n  Tooltip.prototype.render = function () {\n    if (this.get('customContent')) {\n      this.renderCustomContent();\n    } else {\n      this.resetTitle();\n      this.renderItems();\n    }\n    // 绘制完成后，再定位\n    this.resetPosition();\n  };\n  // 复写清空函数，因为有模板的存在，所以默认的写法不合适\n  Tooltip.prototype.clear = function () {\n    // 由于 crosshair 没有在 container 内，所以需要单独清理\n    this.clearCrosshairs();\n    this.setTitle(''); // 清空标题\n    this.clearItemDoms();\n  };\n  Tooltip.prototype.show = function () {\n    var container = this.getContainer();\n    if (!container || this.destroyed) {\n      // 防止容器不存在或者被销毁时报错\n      return;\n    }\n    this.set('visible', true);\n    modifyCSS(container, {\n      visibility: 'visible'\n    });\n    this.setCrossHairsVisible(true);\n  };\n  Tooltip.prototype.hide = function () {\n    var container = this.getContainer();\n    // relative: https://github.com/antvis/g2/issues/1221\n    if (!container || this.destroyed) {\n      return;\n    }\n    this.set('visible', false);\n    modifyCSS(container, {\n      visibility: 'hidden'\n    });\n    this.setCrossHairsVisible(false);\n  };\n  // 实现 IPointLocation 的接口\n  Tooltip.prototype.getLocation = function () {\n    return {\n      x: this.get('x'),\n      y: this.get('y')\n    };\n  };\n  // 实现 IPointLocation 的接口\n  Tooltip.prototype.setLocation = function (point) {\n    this.set('x', point.x);\n    this.set('y', point.y);\n    this.resetPosition();\n  };\n  Tooltip.prototype.setCrossHairsVisible = function (visible) {\n    var display = visible ? '' : 'none';\n    var xCrosshairDom = this.get('xCrosshairDom');\n    var yCrosshairDom = this.get('yCrosshairDom');\n    xCrosshairDom && modifyCSS(xCrosshairDom, {\n      display: display\n    });\n    yCrosshairDom && modifyCSS(yCrosshairDom, {\n      display: display\n    });\n  };\n  // 如有 customContent 则根据 customContent 设置 container\n  Tooltip.prototype.initContainer = function () {\n    _super.prototype.initContainer.call(this);\n    if (this.get('customContent')) {\n      if (this.get('container')) {\n        this.get('container').remove();\n      }\n      var container = this.getHtmlContentNode();\n      this.get('parent').appendChild(container);\n      this.set('container', container);\n      this.resetStyles();\n      this.applyStyles();\n    }\n  };\n  // 更新属性的同时，可能会引起 DOM 的变化，这里对可能引起 DOM 变化的场景做了处理\n  Tooltip.prototype.updateInner = function (cfg) {\n    if (this.get('customContent')) {\n      this.renderCustomContent();\n    } else {\n      // 更新标题\n      if (hasOneKey(cfg, ['title', 'showTitle'])) {\n        this.resetTitle();\n      }\n      // 更新内容\n      if (hasKey(cfg, 'items')) {\n        this.renderItems();\n      }\n    }\n    _super.prototype.updateInner.call(this, cfg);\n  };\n  Tooltip.prototype.initDom = function () {\n    this.cacheDoms();\n  };\n  // 清理 DOM\n  Tooltip.prototype.removeDom = function () {\n    _super.prototype.removeDom.call(this);\n    this.clearCrosshairs();\n  };\n  // 调整位置\n  Tooltip.prototype.resetPosition = function () {\n    var x = this.get('x');\n    var y = this.get('y');\n    var offset = this.get('offset');\n    var _a = this.getOffset(),\n      offsetX = _a.offsetX,\n      offsetY = _a.offsetY;\n    var position = this.get('position');\n    var region = this.get('region');\n    var container = this.getContainer();\n    var bbox = this.getBBox();\n    var width = bbox.width,\n      height = bbox.height;\n    var limitBox;\n    if (region) {\n      // 不限制位置\n      limitBox = regionToBBox(region);\n    }\n    var point = getAlignPoint(x, y, offset, width, height, position, limitBox);\n    modifyCSS(container, {\n      left: toPx(point.x + offsetX),\n      top: toPx(point.y + offsetY)\n    });\n    this.resetCrosshairs();\n  };\n  // 根据 customContent 渲染\n  Tooltip.prototype.renderCustomContent = function () {\n    var node = this.getHtmlContentNode();\n    var parent = this.get('parent');\n    var curContainer = this.get('container');\n    if (curContainer && curContainer.parentNode === parent) {\n      parent.replaceChild(node, curContainer);\n    } else {\n      parent.appendChild(node);\n    }\n    this.set('container', node);\n    this.resetStyles();\n    this.applyStyles();\n  };\n  Tooltip.prototype.getHtmlContentNode = function () {\n    var node;\n    var customContent = this.get('customContent');\n    if (customContent) {\n      var elem = customContent(this.get('title'), this.get('items'));\n      if (isElement(elem)) {\n        node = elem;\n      } else {\n        node = createDom(elem);\n      }\n    }\n    return node;\n  };\n  // 缓存模板设置的各种 DOM\n  Tooltip.prototype.cacheDoms = function () {\n    var container = this.getContainer();\n    var titleDom = container.getElementsByClassName(CssConst.TITLE_CLASS)[0];\n    var listDom = container.getElementsByClassName(CssConst.LIST_CLASS)[0];\n    this.set('titleDom', titleDom);\n    this.set('listDom', listDom);\n  };\n  // 重置 title\n  Tooltip.prototype.resetTitle = function () {\n    var title = this.get('title');\n    var showTitle = this.get('showTitle');\n    if (showTitle && title) {\n      this.setTitle(title);\n    } else {\n      this.setTitle('');\n    }\n  };\n  // 设置 title 文本\n  Tooltip.prototype.setTitle = function (text) {\n    var titleDom = this.get('titleDom');\n    if (titleDom) {\n      titleDom.innerText = text;\n    }\n  };\n  // 终止 crosshair\n  Tooltip.prototype.resetCrosshairs = function () {\n    var crosshairsRegion = this.get('crosshairsRegion');\n    var crosshairs = this.get('crosshairs');\n    if (!crosshairsRegion || !crosshairs) {\n      // 不显示 crosshair，都移除，没有设定 region 也都移除掉\n      this.clearCrosshairs();\n    } else {\n      var crosshairBox = regionToBBox(crosshairsRegion);\n      var xCrosshairDom = this.get('xCrosshairDom');\n      var yCrosshairDom = this.get('yCrosshairDom');\n      if (crosshairs === 'x') {\n        this.resetCrosshair('x', crosshairBox);\n        // 仅显示 x 的 crosshair，y 移除\n        if (yCrosshairDom) {\n          yCrosshairDom.remove();\n          this.set('yCrosshairDom', null);\n        }\n      } else if (crosshairs === 'y') {\n        this.resetCrosshair('y', crosshairBox);\n        // 仅显示 y 的 crosshair，x 移除\n        if (xCrosshairDom) {\n          xCrosshairDom.remove();\n          this.set('xCrosshairDom', null);\n        }\n      } else {\n        this.resetCrosshair('x', crosshairBox);\n        this.resetCrosshair('y', crosshairBox);\n      }\n      this.setCrossHairsVisible(this.get('visible'));\n    }\n  };\n  // 设定 crosshair 的位置，需要区分 x,y\n  Tooltip.prototype.resetCrosshair = function (name, bbox) {\n    var croshairDom = this.checkCrosshair(name);\n    var value = this.get(name);\n    if (name === 'x') {\n      modifyCSS(croshairDom, {\n        left: toPx(value),\n        top: toPx(bbox.y),\n        height: toPx(bbox.height)\n      });\n    } else {\n      modifyCSS(croshairDom, {\n        top: toPx(value),\n        left: toPx(bbox.x),\n        width: toPx(bbox.width)\n      });\n    }\n  };\n  // 如果 crosshair 对应的 dom 不存在，则创建\n  Tooltip.prototype.checkCrosshair = function (name) {\n    var domName = name + \"CrosshairDom\";\n    var tplName = name + \"CrosshairTpl\";\n    var constName = \"CROSSHAIR_\" + name.toUpperCase();\n    var styleName = CssConst[constName];\n    var croshairDom = this.get(domName);\n    var parent = this.get('parent');\n    if (!croshairDom) {\n      croshairDom = createDom(this.get(tplName)); // 创建\n      this.applyStyle(styleName, croshairDom); // 设置初始样式\n      parent.appendChild(croshairDom); // 添加到跟 tooltip 同级的目录下\n      this.set(domName, croshairDom);\n    }\n    return croshairDom;\n  };\n  Tooltip.prototype.renderItems = function () {\n    this.clearItemDoms();\n    var items = this.get('items');\n    var itemTpl = this.get('itemTpl');\n    var listDom = this.get('listDom');\n    if (listDom) {\n      each(items, function (item) {\n        var color = colorUtil.toCSSGradient(item.color);\n        var substituteObj = __assign(__assign({}, item), {\n          color: color\n        });\n        var domStr = substitute(itemTpl, substituteObj);\n        var itemDom = createDom(domStr);\n        listDom.appendChild(itemDom);\n      });\n      this.applyChildrenStyles(listDom, this.get('domStyles'));\n    }\n  };\n  Tooltip.prototype.clearItemDoms = function () {\n    if (this.get('listDom')) {\n      clearDom(this.get('listDom'));\n    }\n  };\n  Tooltip.prototype.clearCrosshairs = function () {\n    var xCrosshairDom = this.get('xCrosshairDom');\n    var yCrosshairDom = this.get('yCrosshairDom');\n    xCrosshairDom && xCrosshairDom.remove();\n    yCrosshairDom && yCrosshairDom.remove();\n    this.set('xCrosshairDom', null);\n    this.set('yCrosshairDom', null);\n  };\n  return Tooltip;\n}(HtmlComponent);\nexport default Tooltip;","map":null,"metadata":{},"sourceType":"module"}