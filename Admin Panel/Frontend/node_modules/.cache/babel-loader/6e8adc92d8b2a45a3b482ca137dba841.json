{"ast":null,"code":"import { __extends } from \"tslib\";\nimport { detect } from 'detect-browser';\nimport Container from './container';\nimport { isBrowser, isNil, isString } from '../util/util';\nimport Timeline from '../animate/timeline';\nimport EventController from '../event/event-contoller';\nvar PX_SUFFIX = 'px';\nvar browser = detect();\nvar isFirefox = browser && browser.name === 'firefox';\nvar Canvas = /** @class */function (_super) {\n  __extends(Canvas, _super);\n  function Canvas(cfg) {\n    var _this = _super.call(this, cfg) || this;\n    _this.initContainer();\n    _this.initDom();\n    _this.initEvents();\n    _this.initTimeline();\n    return _this;\n  }\n  Canvas.prototype.getDefaultCfg = function () {\n    var cfg = _super.prototype.getDefaultCfg.call(this);\n    // set default cursor style for canvas\n    cfg['cursor'] = 'default';\n    // CSS transform 目前尚未经过长时间验证，为了避免影响上层业务，默认关闭，上层按需开启\n    cfg['supportCSSTransform'] = false;\n    return cfg;\n  };\n  /**\n   * @protected\n   * 初始化容器\n   */\n  Canvas.prototype.initContainer = function () {\n    var container = this.get('container');\n    if (isString(container)) {\n      container = document.getElementById(container);\n      this.set('container', container);\n    }\n  };\n  /**\n   * @protected\n   * 初始化 DOM\n   */\n  Canvas.prototype.initDom = function () {\n    var el = this.createDom();\n    this.set('el', el);\n    // 附加到容器\n    var container = this.get('container');\n    container.appendChild(el);\n    // 设置初始宽度\n    this.setDOMSize(this.get('width'), this.get('height'));\n  };\n  /**\n   * @protected\n   * 初始化绑定的事件\n   */\n  Canvas.prototype.initEvents = function () {\n    var eventController = new EventController({\n      canvas: this\n    });\n    eventController.init();\n    this.set('eventController', eventController);\n  };\n  /**\n   * @protected\n   * 初始化时间轴\n   */\n  Canvas.prototype.initTimeline = function () {\n    var timeline = new Timeline(this);\n    this.set('timeline', timeline);\n  };\n  /**\n   * @protected\n   * 修改画布对应的 DOM 的大小\n   * @param {number} width  宽度\n   * @param {number} height 高度\n   */\n  Canvas.prototype.setDOMSize = function (width, height) {\n    var el = this.get('el');\n    if (isBrowser) {\n      el.style.width = width + PX_SUFFIX;\n      el.style.height = height + PX_SUFFIX;\n    }\n  };\n  // 实现接口\n  Canvas.prototype.changeSize = function (width, height) {\n    this.setDOMSize(width, height);\n    this.set('width', width);\n    this.set('height', height);\n    this.onCanvasChange('changeSize');\n  };\n  /**\n   * 获取当前的渲染引擎\n   * @return {Renderer} 返回当前的渲染引擎\n   */\n  Canvas.prototype.getRenderer = function () {\n    return this.get('renderer');\n  };\n  /**\n   * 获取画布的 cursor 样式\n   * @return {Cursor}\n   */\n  Canvas.prototype.getCursor = function () {\n    return this.get('cursor');\n  };\n  /**\n   * 设置画布的 cursor 样式\n   * @param {Cursor} cursor  cursor 样式\n   */\n  Canvas.prototype.setCursor = function (cursor) {\n    this.set('cursor', cursor);\n    var el = this.get('el');\n    if (isBrowser && el) {\n      // 直接设置样式，不等待鼠标移动时再设置\n      el.style.cursor = cursor;\n    }\n  };\n  // 实现接口\n  Canvas.prototype.getPointByEvent = function (ev) {\n    var supportCSSTransform = this.get('supportCSSTransform');\n    if (supportCSSTransform) {\n      // For Firefox <= 38\n      if (isFirefox && !isNil(ev.layerX) && ev.layerX !== ev.offsetX) {\n        return {\n          x: ev.layerX,\n          y: ev.layerY\n        };\n      }\n      if (!isNil(ev.offsetX)) {\n        // For IE6+, Firefox >= 39, Chrome, Safari, Opera\n        return {\n          x: ev.offsetX,\n          y: ev.offsetY\n        };\n      }\n    }\n    // should calculate by self for other cases, like Safari in ios\n    // TODO: support CSS transform\n    var _a = this.getClientByEvent(ev),\n      clientX = _a.x,\n      clientY = _a.y;\n    return this.getPointByClient(clientX, clientY);\n  };\n  // 获取 touch 事件的 clientX 和 clientY 需要单独处理\n  Canvas.prototype.getClientByEvent = function (ev) {\n    var clientInfo = ev;\n    if (ev.touches) {\n      if (ev.type === 'touchend') {\n        clientInfo = ev.changedTouches[0];\n      } else {\n        clientInfo = ev.touches[0];\n      }\n    }\n    return {\n      x: clientInfo.clientX,\n      y: clientInfo.clientY\n    };\n  };\n  // 实现接口\n  Canvas.prototype.getPointByClient = function (clientX, clientY) {\n    var el = this.get('el');\n    var bbox = el.getBoundingClientRect();\n    return {\n      x: clientX - bbox.left,\n      y: clientY - bbox.top\n    };\n  };\n  // 实现接口\n  Canvas.prototype.getClientByPoint = function (x, y) {\n    var el = this.get('el');\n    var bbox = el.getBoundingClientRect();\n    return {\n      x: x + bbox.left,\n      y: y + bbox.top\n    };\n  };\n  // 实现接口\n  Canvas.prototype.draw = function () {};\n  /**\n   * @protected\n   * 销毁 DOM 容器\n   */\n  Canvas.prototype.removeDom = function () {\n    var el = this.get('el');\n    el.parentNode.removeChild(el);\n  };\n  /**\n   * @protected\n   * 清理所有的事件\n   */\n  Canvas.prototype.clearEvents = function () {\n    var eventController = this.get('eventController');\n    eventController.destroy();\n  };\n  Canvas.prototype.isCanvas = function () {\n    return true;\n  };\n  Canvas.prototype.getParent = function () {\n    return null;\n  };\n  Canvas.prototype.destroy = function () {\n    var timeline = this.get('timeline');\n    if (this.get('destroyed')) {\n      return;\n    }\n    this.clear();\n    // 同初始化时相反顺序调用\n    if (timeline) {\n      // 画布销毁时自动停止动画\n      timeline.stop();\n    }\n    this.clearEvents();\n    this.removeDom();\n    _super.prototype.destroy.call(this);\n  };\n  return Canvas;\n}(Container);\nexport default Canvas;","map":null,"metadata":{},"sourceType":"module"}