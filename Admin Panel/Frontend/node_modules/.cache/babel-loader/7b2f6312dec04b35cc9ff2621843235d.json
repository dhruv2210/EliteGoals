{"ast":null,"code":"import { __assign, __extends, __rest } from \"tslib\";\nimport { difference, each, isNil, keys, mix, pick } from '@antv/util';\nimport { propagationDelegate } from '../util/event';\nimport { applyMatrix2BBox, getMatrixByTranslate } from '../util/matrix';\nimport { getBBoxWithClip, updateClip } from '../util/util';\nimport Component from './component';\nvar STATUS_UPDATE = 'update_status';\nvar COPY_PROPERTIES = ['visible', 'tip', 'delegateObject']; // 更新对象时需要复制的属性\nvar COPY_PROPERTIES_EXCLUDES = ['container', 'group', 'shapesMap', 'isRegister', 'isUpdating', 'destroyed']; // 更新子组件时排除的属性\nvar GroupComponent = /** @class */function (_super) {\n  __extends(GroupComponent, _super);\n  function GroupComponent() {\n    return _super !== null && _super.apply(this, arguments) || this;\n  }\n  GroupComponent.prototype.getDefaultCfg = function () {\n    var cfg = _super.prototype.getDefaultCfg.call(this);\n    return __assign(__assign({}, cfg), {\n      container: null,\n      /**\n       * @private\n       * 缓存图形的 Map\n       */\n      shapesMap: {},\n      group: null,\n      capture: true,\n      /**\n       * @private 组件或者图形是否允许注册\n       * @type {false}\n       */\n      isRegister: false,\n      /**\n       * @private 是否正在更新\n       * @type {false}\n       */\n      isUpdating: false,\n      /**\n       * @private\n       * 是否初始状态，一旦 render，update 后，这个状态就变成 false, clear 后恢复\n       */\n      isInit: true\n    });\n  };\n  GroupComponent.prototype.remove = function () {\n    this.clear();\n    var group = this.get('group');\n    group.remove();\n  };\n  GroupComponent.prototype.clear = function () {\n    var group = this.get('group');\n    group.clear();\n    this.set('shapesMap', {});\n    this.clearOffScreenCache();\n    this.set('isInit', true);\n  };\n  GroupComponent.prototype.getChildComponentById = function (id) {\n    var group = this.getElementById(id);\n    var inst = group && group.get('component');\n    return inst;\n  };\n  GroupComponent.prototype.getElementById = function (id) {\n    return this.get('shapesMap')[id];\n  };\n  GroupComponent.prototype.getElementByLocalId = function (localId) {\n    var id = this.getElementId(localId);\n    return this.getElementById(id);\n  };\n  GroupComponent.prototype.getElementsByName = function (name) {\n    var rst = [];\n    each(this.get('shapesMap'), function (elem) {\n      if (elem.get('name') === name) {\n        rst.push(elem);\n      }\n    });\n    return rst;\n  };\n  GroupComponent.prototype.getContainer = function () {\n    return this.get('container');\n  };\n  GroupComponent.prototype.updateInner = function (cfg) {\n    // this.updateInner();\n    // this.set('isUpdating', false);\n    this.offScreenRender();\n    if (this.get('updateAutoRender')) {\n      this.render();\n    }\n  };\n  GroupComponent.prototype.render = function () {\n    var offScreenGroup = this.get('offScreenGroup');\n    if (!offScreenGroup) {\n      offScreenGroup = this.offScreenRender();\n    }\n    var group = this.get('group');\n    this.updateElements(offScreenGroup, group);\n    this.deleteElements();\n    this.applyOffset();\n    if (!this.get('eventInitted')) {\n      this.initEvent();\n      this.set('eventInitted', true);\n    }\n    this.set('isInit', false);\n  };\n  GroupComponent.prototype.show = function () {\n    var group = this.get('group');\n    group.show();\n    this.set('visible', true);\n  };\n  GroupComponent.prototype.hide = function () {\n    var group = this.get('group');\n    group.hide();\n    this.set('visible', false);\n  };\n  GroupComponent.prototype.setCapture = function (capture) {\n    var group = this.get('group');\n    group.set('capture', capture);\n    this.set('capture', capture);\n  };\n  GroupComponent.prototype.destroy = function () {\n    this.removeEvent();\n    this.remove();\n    _super.prototype.destroy.call(this);\n  };\n  GroupComponent.prototype.getBBox = function () {\n    return this.get('group').getCanvasBBox();\n  };\n  GroupComponent.prototype.getLayoutBBox = function () {\n    var group = this.get('group');\n    // 防止被 clear 了，offScreenBBox 不存在\n    var bbox = this.getInnerLayoutBBox();\n    var matrix = group.getTotalMatrix();\n    if (matrix) {\n      bbox = applyMatrix2BBox(matrix, bbox);\n    }\n    return bbox; // 默认返回 getBBox，不同的组件内部单独实现\n  };\n  // 复写 on, off, emit 透传到 group\n  GroupComponent.prototype.on = function (evt, callback, once) {\n    var group = this.get('group');\n    group.on(evt, callback, once);\n    return this;\n  };\n  GroupComponent.prototype.off = function (evt, callback) {\n    var group = this.get('group');\n    group && group.off(evt, callback);\n    return this;\n  };\n  GroupComponent.prototype.emit = function (eventName, eventObject) {\n    var group = this.get('group');\n    group.emit(eventName, eventObject);\n  };\n  GroupComponent.prototype.init = function () {\n    _super.prototype.init.call(this);\n    if (!this.get('group')) {\n      this.initGroup();\n    }\n    this.offScreenRender(); // 绘制离屏 group\n  };\n  // 获取组件内部布局占的包围盒\n  GroupComponent.prototype.getInnerLayoutBBox = function () {\n    return this.get('offScreenBBox') || this.get('group').getBBox();\n  };\n  // 抛出委托对象\n  GroupComponent.prototype.delegateEmit = function (eventName, eventObject) {\n    var group = this.get('group');\n    eventObject.target = group;\n    group.emit(eventName, eventObject);\n    propagationDelegate(group, eventName, eventObject);\n  };\n  // 创建离屏的 group ,不添加在 canvas 中\n  GroupComponent.prototype.createOffScreenGroup = function () {\n    var group = this.get('group');\n    var GroupClass = group.getGroupBase(); // 获取分组的构造函数\n    var newGroup = new GroupClass({\n      delegateObject: this.getDelegateObject()\n    });\n    return newGroup;\n  };\n  // 应用 offset\n  GroupComponent.prototype.applyOffset = function () {\n    var offsetX = this.get('offsetX');\n    var offsetY = this.get('offsetY');\n    this.moveElementTo(this.get('group'), {\n      x: offsetX,\n      y: offsetY\n    });\n  };\n  GroupComponent.prototype.initGroup = function () {\n    var container = this.get('container');\n    this.set('group', container.addGroup({\n      id: this.get('id'),\n      name: this.get('name'),\n      capture: this.get('capture'),\n      visible: this.get('visible'),\n      isComponent: true,\n      component: this,\n      delegateObject: this.getDelegateObject()\n    }));\n  };\n  // 离屏渲染\n  GroupComponent.prototype.offScreenRender = function () {\n    this.clearOffScreenCache();\n    var offScreenGroup = this.createOffScreenGroup();\n    this.renderInner(offScreenGroup);\n    this.set('offScreenGroup', offScreenGroup);\n    // 包含包围盒的 bbox\n    this.set('offScreenBBox', getBBoxWithClip(offScreenGroup));\n    return offScreenGroup;\n  };\n  /**\n   * @protected\n   * 在组件上添加分组，主要解决 isReigeter 的问题\n   * @param {IGroup} parent 父元素\n   * @param {object} cfg    分组的配置项\n   */\n  GroupComponent.prototype.addGroup = function (parent, cfg) {\n    this.appendDelegateObject(parent, cfg);\n    var group = parent.addGroup(cfg);\n    if (this.get('isRegister')) {\n      this.registerElement(group);\n    }\n    return group;\n  };\n  /**\n   * @protected\n   * 在组件上添加图形，主要解决 isReigeter 的问题\n   * @param {IGroup} parent 父元素\n   * @param {object} cfg    分组的配置项\n   */\n  GroupComponent.prototype.addShape = function (parent, cfg) {\n    this.appendDelegateObject(parent, cfg);\n    var shape = parent.addShape(cfg);\n    if (this.get('isRegister')) {\n      this.registerElement(shape);\n    }\n    return shape;\n  };\n  /**\n   * 在组件上添加子组件\n   *\n   * @param parent 父元素\n   * @param cfg 子组件配置项\n   */\n  GroupComponent.prototype.addComponent = function (parent, cfg) {\n    var id = cfg.id,\n      Ctor = cfg.component,\n      restCfg = __rest(cfg, [\"id\", \"component\"]);\n    // @ts-ignore\n    var inst = new Ctor(__assign(__assign({}, restCfg), {\n      id: id,\n      container: parent,\n      updateAutoRender: this.get('updateAutoRender')\n    }));\n    inst.init();\n    inst.render();\n    if (this.get('isRegister')) {\n      this.registerElement(inst.get('group'));\n    }\n    return inst;\n  };\n  GroupComponent.prototype.initEvent = function () {};\n  GroupComponent.prototype.removeEvent = function () {\n    var group = this.get('group');\n    group.off();\n  };\n  GroupComponent.prototype.getElementId = function (localId) {\n    var id = this.get('id'); // 组件的 Id\n    var name = this.get('name'); // 组件的名称\n    return id + \"-\" + name + \"-\" + localId;\n  };\n  GroupComponent.prototype.registerElement = function (element) {\n    var id = element.get('id');\n    this.get('shapesMap')[id] = element;\n  };\n  GroupComponent.prototype.unregisterElement = function (element) {\n    var id = element.get('id');\n    delete this.get('shapesMap')[id];\n  };\n  // 移动元素\n  GroupComponent.prototype.moveElementTo = function (element, point) {\n    var matrix = getMatrixByTranslate(point);\n    element.attr('matrix', matrix);\n  };\n  /**\n   * 图形元素新出现时的动画，默认图形从透明度 0 到当前透明度\n   * @protected\n   * @param {string} elmentName 图形元素名称\n   * @param {IElement} newElement  新的图形元素\n   * @param {object} animateCfg 动画的配置项\n   */\n  GroupComponent.prototype.addAnimation = function (elmentName, newElement, animateCfg) {\n    // 缓存透明度\n    var originOpacity = newElement.attr('opacity');\n    if (isNil(originOpacity)) {\n      originOpacity = 1;\n    }\n    newElement.attr('opacity', 0);\n    newElement.animate({\n      opacity: originOpacity\n    }, animateCfg);\n  };\n  /**\n   * 图形元素新出现时的动画，默认图形从透明度 0 到当前透明度\n   * @protected\n   * @param {string} elmentName 图形元素名称\n   * @param {IElement} originElement 要删除的图形元素\n   * @param {object} animateCfg 动画的配置项\n   */\n  GroupComponent.prototype.removeAnimation = function (elementName, originElement, animateCfg) {\n    originElement.animate({\n      opacity: 0\n    }, animateCfg);\n  };\n  /**\n   * 图形元素的更新动画\n   * @param {string} elmentName 图形元素名称\n   * @param {IElement} originElement 现有的图形元素\n   * @param {object} newAttrs  新的图形元素\n   * @param {object} animateCfg 动画的配置项\n   */\n  GroupComponent.prototype.updateAnimation = function (elementName, originElement, newAttrs, animateCfg) {\n    originElement.animate(newAttrs, animateCfg);\n  };\n  // 更新组件的图形\n  GroupComponent.prototype.updateElements = function (newGroup, originGroup) {\n    var _this = this;\n    var animate = this.get('animate');\n    var animateOption = this.get('animateOption');\n    var children = newGroup.getChildren().slice(0); // 创建一个新数组，防止添加到 originGroup 时， children 变动\n    var preElement; // 前面已经匹配到的图形元素，用于\n    each(children, function (element) {\n      var elementId = element.get('id');\n      var originElement = _this.getElementById(elementId);\n      var elementName = element.get('name');\n      if (originElement) {\n        if (element.get('isComponent')) {\n          // 嵌套子组件更新\n          var childComponent = element.get('component');\n          var origChildComponent = originElement.get('component');\n          var newCfg = pick(childComponent.cfg, difference(keys(childComponent.cfg), COPY_PROPERTIES_EXCLUDES));\n          origChildComponent.update(newCfg);\n          originElement.set(STATUS_UPDATE, 'update');\n        } else {\n          var replaceAttrs = _this.getReplaceAttrs(originElement, element);\n          // 更新\n          if (animate && animateOption.update) {\n            // 没有动画\n            _this.updateAnimation(elementName, originElement, replaceAttrs, animateOption.update);\n          } else {\n            // originElement.attrs = replaceAttrs; // 直接替换\n            originElement.attr(replaceAttrs);\n          }\n          // 如果是分组，则继续执行\n          if (element.isGroup()) {\n            _this.updateElements(element, originElement);\n          }\n          // 复制属性\n          each(COPY_PROPERTIES, function (name) {\n            originElement.set(name, element.get(name));\n          });\n          updateClip(originElement, element);\n          preElement = originElement;\n          // 执行完更新后设置状态位为更新\n          originElement.set(STATUS_UPDATE, 'update');\n        }\n      } else {\n        // 没有对应的图形，则插入当前图形\n        originGroup.add(element); // 应该在 group 加个 insertAt 的方法\n        var siblings = originGroup.getChildren(); // 兄弟节点\n        siblings.splice(siblings.length - 1, 1); // 先从数组中移除，然后放到合适的位置\n        if (preElement) {\n          // 前面已经有更新的图形或者插入的图形，则在这个图形后面插入\n          var index = siblings.indexOf(preElement);\n          siblings.splice(index + 1, 0, element); // 在已经更新的图形元素后面插入\n        } else {\n          siblings.unshift(element);\n        }\n        _this.registerElement(element); // 注册节点\n        element.set(STATUS_UPDATE, 'add'); // 执行完更新后设置状态位为添加\n        if (element.get('isComponent')) {\n          // 直接新增子组件container属性，实例不变\n          var childComponent = element.get('component');\n          childComponent.set('container', originGroup);\n        } else if (element.isGroup()) {\n          // 如果元素是新增加的元素，则遍历注册所有的子节点\n          _this.registerNewGroup(element);\n        }\n        preElement = element;\n        if (animate) {\n          var animateCfg = _this.get('isInit') ? animateOption.appear : animateOption.enter;\n          if (animateCfg) {\n            _this.addAnimation(elementName, element, animateCfg);\n          }\n        }\n      }\n    });\n  };\n  GroupComponent.prototype.clearUpdateStatus = function (group) {\n    var children = group.getChildren();\n    each(children, function (el) {\n      el.set(STATUS_UPDATE, null); // 清理掉更新状态\n    });\n  };\n  // 清理离屏缓存\n  GroupComponent.prototype.clearOffScreenCache = function () {\n    var offScreenGroup = this.get('offScreenGroup');\n    if (offScreenGroup) {\n      // 销毁原先的离线 Group\n      offScreenGroup.destroy();\n    }\n    this.set('offScreenGroup', null);\n    this.set('offScreenBBox', null);\n  };\n  // private updateInner() {\n  //   const group = this.get('group');\n  //   const newGroup = this.createOffScreenGroup();\n  //   this.renderInner(newGroup);\n  //   this.applyOffset();\n  //   this.updateElements(newGroup, group);\n  //   this.deleteElements();\n  //   newGroup.destroy(); // 销毁虚拟分组\n  // }\n  // 获取发生委托时的对象，在事件中抛出\n  GroupComponent.prototype.getDelegateObject = function () {\n    var _a;\n    var name = this.get('name');\n    var delegateObject = (_a = {}, _a[name] = this, _a.component = this, _a);\n    return delegateObject;\n  };\n  // 附加委托信息，用于事件\n  GroupComponent.prototype.appendDelegateObject = function (parent, cfg) {\n    var parentObject = parent.get('delegateObject');\n    if (!cfg.delegateObject) {\n      cfg.delegateObject = {};\n    }\n    mix(cfg.delegateObject, parentObject); // 将父元素上的委托信息复制到自身\n  };\n  // 获取需要替换的属性，如果原先图形元素存在，而新图形不存在，则设置 undefined\n  GroupComponent.prototype.getReplaceAttrs = function (originElement, newElement) {\n    var originAttrs = originElement.attr();\n    var newAttrs = newElement.attr();\n    each(originAttrs, function (v, k) {\n      if (newAttrs[k] === undefined) {\n        newAttrs[k] = undefined;\n      }\n    });\n    return newAttrs;\n  };\n  GroupComponent.prototype.registerNewGroup = function (group) {\n    var _this = this;\n    var children = group.getChildren();\n    each(children, function (element) {\n      _this.registerElement(element); // 注册节点\n      element.set(STATUS_UPDATE, 'add'); // 执行完更新后设置状态位为添加\n      if (element.isGroup()) {\n        _this.registerNewGroup(element);\n      }\n    });\n  };\n  // 移除多余的元素\n  GroupComponent.prototype.deleteElements = function () {\n    var _this = this;\n    var shapesMap = this.get('shapesMap');\n    var deleteArray = [];\n    // 遍历获取需要删除的图形元素\n    each(shapesMap, function (element, id) {\n      if (!element.get(STATUS_UPDATE) || element.destroyed) {\n        deleteArray.push([id, element]);\n      } else {\n        element.set(STATUS_UPDATE, null); // 清理掉更新状态\n      }\n    });\n\n    var animate = this.get('animate');\n    var animateOption = this.get('animateOption');\n    // 删除图形元素\n    each(deleteArray, function (item) {\n      var id = item[0],\n        element = item[1];\n      if (!element.destroyed) {\n        var elementName = element.get('name');\n        if (animate && animateOption.leave) {\n          // 需要动画结束时移除图形\n          var callbackAnimCfg = mix({\n            callback: function callback() {\n              _this.removeElement(element);\n            }\n          }, animateOption.leave);\n          _this.removeAnimation(elementName, element, callbackAnimCfg);\n        } else {\n          _this.removeElement(element);\n        }\n      }\n      delete shapesMap[id]; // 从缓存中移除\n    });\n  };\n\n  GroupComponent.prototype.removeElement = function (element) {\n    if (element.get('isGroup')) {\n      var component = element.get('component');\n      if (component) {\n        component.destroy();\n      }\n    }\n    element.remove();\n  };\n  return GroupComponent;\n}(Component);\nexport default GroupComponent;","map":null,"metadata":{},"sourceType":"module"}