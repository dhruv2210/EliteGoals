{"ast":null,"code":"import { __assign, __extends } from \"tslib\";\nimport { Action, Util } from '@antv/g2';\nimport { get, isNil, last, size } from '@antv/util';\nimport { deepAssign } from '../../utils/deep-assign';\n// 面包屑文字和分割符'/'之间的距离\nvar PADDING = 4;\n// 面包屑位置距离树图的距离\nvar PADDING_LEFT = 0;\n// 面包屑位置距离树图的顶部距离\nexport var PADDING_TOP = 5;\n/** Group name of breadCrumb: 面包屑 */\nexport var BREAD_CRUMB_NAME = 'drilldown-bread-crumb';\n// 面包屑默认配置\nexport var DEFAULT_BREAD_CRUMB_CONFIG = {\n  /** 位置，默认：左上角 */\n  position: 'top-left',\n  dividerText: '/',\n  textStyle: {\n    fontSize: 12,\n    fill: 'rgba(0, 0, 0, 0.65)',\n    cursor: 'pointer'\n  },\n  activeTextStyle: {\n    fill: '#87B5FF'\n  }\n};\n/**\n * hierarchy 数据转换的参数\n */\nexport var HIERARCHY_DATA_TRANSFORM_PARAMS = 'hierarchy-data-transform-params';\n/**\n * @description 下钻交互的 action\n * @author liuzhenying\n *\n * 适用于：hierarchy plot\n */\nvar DrillDownAction = /** @class */function (_super) {\n  __extends(DrillDownAction, _super);\n  function DrillDownAction() {\n    var _this = _super !== null && _super.apply(this, arguments) || this;\n    /** Action name */\n    _this.name = 'drill-down';\n    // 存储历史下钻数据\n    _this.historyCache = [];\n    // 面包屑 group\n    _this.breadCrumbGroup = null;\n    // 面包屑基础配置\n    _this.breadCrumbCfg = DEFAULT_BREAD_CRUMB_CONFIG;\n    return _this;\n  }\n  /**\n   * 点击事件, 下钻数据，并绘制面包屑\n   */\n  DrillDownAction.prototype.click = function () {\n    var data = get(this.context, ['event', 'data', 'data']);\n    if (!data) return false;\n    this.drill(data);\n    this.drawBreadCrumb();\n  };\n  /**\n   * 重置位置，初始化及触发 chart  afterchangesize 回调时使用\n   */\n  DrillDownAction.prototype.resetPosition = function () {\n    // 当在第一层级未绘制面包屑，此时 changedata 触发 resetPosition 函数，需判断 this.breadCrumbGroup 是否存在\n    if (!this.breadCrumbGroup) return;\n    var coordinate = this.context.view.getCoordinate();\n    var breadCrumbGroup = this.breadCrumbGroup;\n    var bbox = breadCrumbGroup.getBBox();\n    var position = this.getButtonCfg().position;\n    // @todo 后续抽取一个函数来处理，以及增加 margin 或者 padding 的设置\n    // 非 polar 的，需要使用 coordinate，除却图表组件\n    var point = {\n      x: coordinate.start.x,\n      y: coordinate.end.y - (bbox.height + PADDING_TOP * 2)\n    };\n    if (coordinate.isPolar) {\n      // 默认，左上角直接出发\n      point = {\n        x: 0,\n        y: 0\n      };\n    }\n    if (position === 'bottom-left') {\n      // 涉及到坐标反转的问题\n      point = {\n        x: coordinate.start.x,\n        y: coordinate.start.y\n      };\n    }\n    /** PADDING_LEFT, PADDING_TOP 与画布边缘的距离 */\n    var matrix = Util.transform(null, [['t', point.x + PADDING_LEFT, point.y + bbox.height + PADDING_TOP]]);\n    breadCrumbGroup.setMatrix(matrix);\n  };\n  /**\n   * 返回上一层\n   */\n  DrillDownAction.prototype.back = function () {\n    if (size(this.historyCache)) {\n      this.backTo(this.historyCache.slice(0, -1));\n    }\n  };\n  /**\n   * 重置\n   */\n  DrillDownAction.prototype.reset = function () {\n    if (this.historyCache[0]) {\n      this.backTo(this.historyCache.slice(0, 1));\n    }\n    // 清空\n    this.historyCache = [];\n    this.hideCrumbGroup();\n  };\n  /**\n   * 下钻数据并更新 view 显示层\n   * @param nodeInfo 下钻数据\n   */\n  DrillDownAction.prototype.drill = function (nodeInfo) {\n    var view = this.context.view;\n    var transformData = get(view, ['interactions', 'drill-down', 'cfg', 'transformData'], function (v) {\n      return v;\n    });\n    // 重新 update 数据\n    var drillData = transformData(__assign({\n      data: nodeInfo.data\n    }, nodeInfo[HIERARCHY_DATA_TRANSFORM_PARAMS]));\n    view.changeData(drillData);\n    // 存储历史记录\n    var historyCache = [];\n    var node = nodeInfo;\n    while (node) {\n      var nodeData = node.data;\n      historyCache.unshift({\n        id: nodeData.name + \"_\" + node.height + \"_\" + node.depth,\n        name: nodeData.name,\n        // children 是实际数据\n        children: transformData(__assign({\n          data: nodeData\n        }, nodeInfo[HIERARCHY_DATA_TRANSFORM_PARAMS]))\n      });\n      node = node.parent;\n    }\n    this.historyCache = (this.historyCache || []).slice(0, -1).concat(historyCache);\n  };\n  /**\n   * 回退事件，点击面包屑时触发\n   * @param historyCache 当前要回退到的历史\n   */\n  DrillDownAction.prototype.backTo = function (historyCache) {\n    if (!historyCache || historyCache.length <= 0) {\n      return;\n    }\n    var view = this.context.view;\n    var data = last(historyCache).children; // 处理后的数组\n    view.changeData(data);\n    if (historyCache.length > 1) {\n      this.historyCache = historyCache;\n      this.drawBreadCrumb();\n    } else {\n      // 清空\n      this.historyCache = [];\n      this.hideCrumbGroup();\n    }\n  };\n  /**\n   * 获取 mix 默认的配置和用户配置\n   */\n  DrillDownAction.prototype.getButtonCfg = function () {\n    var view = this.context.view;\n    var drillDownConfig = get(view, ['interactions', 'drill-down', 'cfg', 'drillDownConfig']);\n    return deepAssign(this.breadCrumbCfg, drillDownConfig === null || drillDownConfig === void 0 ? void 0 : drillDownConfig.breadCrumb, this.cfg);\n  };\n  /**\n   * 显示面包屑\n   */\n  DrillDownAction.prototype.drawBreadCrumb = function () {\n    this.drawBreadCrumbGroup();\n    this.resetPosition();\n    this.breadCrumbGroup.show();\n  };\n  /**\n   * 绘制 Button 和 文本\n   */\n  DrillDownAction.prototype.drawBreadCrumbGroup = function () {\n    var _this = this;\n    var config = this.getButtonCfg();\n    var cache = this.historyCache;\n    // 初始化面包屑 group\n    if (!this.breadCrumbGroup) {\n      this.breadCrumbGroup = this.context.view.foregroundGroup.addGroup({\n        name: BREAD_CRUMB_NAME\n      });\n    } else {\n      this.breadCrumbGroup.clear();\n    }\n    // 绘制面包屑\n    var left = 0;\n    cache.forEach(function (record, index) {\n      // 添加文本\n      var textShape = _this.breadCrumbGroup.addShape({\n        type: 'text',\n        id: record.id,\n        name: BREAD_CRUMB_NAME + \"_\" + record.name + \"_text\",\n        attrs: __assign(__assign({\n          text: index === 0 && !isNil(config.rootText) ? config.rootText : record.name\n        }, config.textStyle), {\n          x: left,\n          y: 0\n        })\n      });\n      var textShapeBox = textShape.getBBox();\n      left += textShapeBox.width + PADDING;\n      // 增加文本事件\n      textShape.on('click', function (event) {\n        var _a;\n        var targetId = event.target.get('id');\n        if (targetId !== ((_a = last(cache)) === null || _a === void 0 ? void 0 : _a.id)) {\n          var newHistoryCache = cache.slice(0, cache.findIndex(function (d) {\n            return d.id === targetId;\n          }) + 1);\n          _this.backTo(newHistoryCache);\n        }\n      });\n      // active 效果内置\n      textShape.on('mouseenter', function (event) {\n        var _a;\n        var targetId = event.target.get('id');\n        if (targetId !== ((_a = last(cache)) === null || _a === void 0 ? void 0 : _a.id)) {\n          textShape.attr(config.activeTextStyle);\n        } else {\n          textShape.attr({\n            cursor: 'default'\n          });\n        }\n      });\n      textShape.on('mouseleave', function () {\n        textShape.attr(config.textStyle);\n      });\n      if (index < cache.length - 1) {\n        // 添加反斜杠\n        var dividerShape = _this.breadCrumbGroup.addShape({\n          type: 'text',\n          name: config.name + \"_\" + record.name + \"_divider\",\n          attrs: __assign(__assign({\n            text: config.dividerText\n          }, config.textStyle), {\n            x: left,\n            y: 0\n          })\n        });\n        var dividerBox = dividerShape.getBBox();\n        left += dividerBox.width + PADDING;\n      }\n    });\n  };\n  /**\n   * 隐藏面包屑\n   */\n  DrillDownAction.prototype.hideCrumbGroup = function () {\n    if (this.breadCrumbGroup) {\n      this.breadCrumbGroup.hide();\n    }\n  };\n  /**\n   * @override\n   * destroy: 销毁资源\n   */\n  DrillDownAction.prototype.destroy = function () {\n    if (this.breadCrumbGroup) {\n      this.breadCrumbGroup.remove();\n    }\n    _super.prototype.destroy.call(this);\n  };\n  return DrillDownAction;\n}(Action);\nexport { DrillDownAction };","map":null,"metadata":{},"sourceType":"module"}