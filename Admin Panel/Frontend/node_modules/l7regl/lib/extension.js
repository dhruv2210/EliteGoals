var check = require('./util/check')

module.exports = function createExtensionCache (gl, config) {
  var extensions = {}

  function tryLoadExtension (name_) {
    check.type(name_, 'string', 'extension name must be string')
    var name = name_.toLowerCase()
    var ext
    try {
      // ext = extensions[name] = gl.getExtension(name)
      // 兼容不同环境扩展大小写
      ext = extensions[name] = getExtension(name_)
    } catch (e) {}
    return !!ext
  }

  // 兼容扩展名不规范的环境，如小程序
  function getExtension(name) {
    if(!!gl.getExtension(name)) {
      return gl.getExtension(name)
    } else if(!!gl.getExtension(name.toLowerCase())) {
      return gl.getExtension(name.toLowerCase())
    } else {
      return null
    }
  }

  for (var i = 0; i < config.extensions.length; ++i) {
    var name = config.extensions[i]
    if (!tryLoadExtension(name)) {
      config.onDestroy()
      config.onDone('"' + name + '" extension is not supported by the current WebGL context, try upgrading your system or a different browser')
      return null
    }
  }

  config.optionalExtensions.forEach(tryLoadExtension)

  return {
    extensions: extensions,
    restore: function () {
      Object.keys(extensions).forEach(function (name) {
        if (extensions[name] && !tryLoadExtension(name)) {
          throw new Error('(regl): error restoring extension ' + name)
        }
      })
    }
  }
}
