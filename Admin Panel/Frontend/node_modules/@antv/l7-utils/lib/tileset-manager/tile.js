var __create = Object.create;
var __defProp = Object.defineProperty;
var __getOwnPropDesc = Object.getOwnPropertyDescriptor;
var __getOwnPropNames = Object.getOwnPropertyNames;
var __getProtoOf = Object.getPrototypeOf;
var __hasOwnProp = Object.prototype.hasOwnProperty;
var __export = (target, all) => {
  for (var name in all)
    __defProp(target, name, { get: all[name], enumerable: true });
};
var __copyProps = (to, from, except, desc) => {
  if (from && typeof from === "object" || typeof from === "function") {
    for (let key of __getOwnPropNames(from))
      if (!__hasOwnProp.call(to, key) && key !== except)
        __defProp(to, key, { get: () => from[key], enumerable: !(desc = __getOwnPropDesc(from, key)) || desc.enumerable });
  }
  return to;
};
var __toESM = (mod, isNodeMode, target) => (target = mod != null ? __create(__getProtoOf(mod)) : {}, __copyProps(
  // If the importer is in node compatibility mode or this is not an ESM
  // file that has been converted to a CommonJS file using a Babel-
  // compatible transform (i.e. "__esModule" has not been set), then set
  // "default" to the CommonJS "module.exports" for node compatibility.
  isNodeMode || !mod || !mod.__esModule ? __defProp(target, "default", { value: mod, enumerable: true }) : target,
  mod
));
var __toCommonJS = (mod) => __copyProps(__defProp({}, "__esModule", { value: true }), mod);

// src/tileset-manager/tile.ts
var tile_exports = {};
__export(tile_exports, {
  SourceTile: () => SourceTile
});
module.exports = __toCommonJS(tile_exports);
var import_bbox_polygon = __toESM(require("@turf/bbox-polygon"));
var import_eventemitter3 = require("eventemitter3");
var import_types = require("./types");
var import_lonlat_tile = require("./utils/lonlat-tile");
var SourceTile = class extends import_eventemitter3.EventEmitter {
  constructor(options) {
    super();
    // 瓦片大小
    this.tileSize = 256;
    // 是否可以见
    this.isVisible = false;
    // 是否是当前层级的瓦片
    this.isCurrent = false;
    // 是否可以见发生变化
    this.isVisibleChange = false;
    this.loadedLayers = 0;
    this.isLayerLoaded = false;
    this.isLoad = false;
    this.isChildLoad = false;
    // 瓦片的父级瓦片
    this.parent = null;
    // 瓦片的子级瓦片
    this.children = [];
    // 瓦片数据
    this.data = null;
    // 瓦片属性
    this.properties = {};
    // 瓦片序号
    this.loadDataId = 0;
    const { x, y, z, tileSize, warp = true } = options;
    this.x = x;
    this.y = y;
    this.z = z;
    this.warp = warp || true;
    this.tileSize = tileSize;
  }
  // 是否正在请求瓦片
  get isLoading() {
    return this.loadStatus === import_types.LoadTileDataStatus.Loading;
  }
  // 是否瓦片请求成功
  get isLoaded() {
    return this.loadStatus === import_types.LoadTileDataStatus.Loaded;
  }
  // 是否瓦片请求失败
  get isFailure() {
    return this.loadStatus === import_types.LoadTileDataStatus.Failure;
  }
  setTileLayerLoaded() {
    this.isLayerLoaded = true;
  }
  // 是否瓦片请求被取消
  get isCancelled() {
    return this.loadStatus === import_types.LoadTileDataStatus.Cancelled;
  }
  // 是否数据请求结束
  get isDone() {
    return [
      import_types.LoadTileDataStatus.Loaded,
      import_types.LoadTileDataStatus.Cancelled,
      import_types.LoadTileDataStatus.Failure
    ].includes(this.loadStatus);
  }
  // 瓦片的经纬度边界
  get bounds() {
    return (0, import_lonlat_tile.tileToBounds)(this.x, this.y, this.z);
  }
  // 瓦片边界面
  get bboxPolygon() {
    const [minLng, minLat, maxLng, maxLat] = this.bounds;
    const center = [(maxLng - minLng) / 2, (maxLat - minLat) / 2];
    const polygon = (0, import_bbox_polygon.default)(this.bounds, {
      properties: {
        key: this.key,
        id: this.key,
        bbox: this.bounds,
        center,
        meta: `
      ${this.key}
      `
        // ${this.bbox.slice(0, 2)}
        // ${this.bbox.slice(2)}
      }
    });
    return polygon;
  }
  // 瓦片的 key
  get key() {
    const key = `${this.x}_${this.y}_${this.z}`;
    return key;
  }
  layerLoad() {
    this.loadedLayers++;
    this.emit("layerLoaded");
  }
  // 请求瓦片数据
  async loadData({ getData, onLoad, onError }) {
    this.loadDataId++;
    const loadDataId = this.loadDataId;
    if (this.isLoading) {
      this.abortLoad();
    }
    this.abortController = new AbortController();
    this.loadStatus = import_types.LoadTileDataStatus.Loading;
    let tileData = null;
    let error;
    try {
      const { x, y, z, bounds, tileSize, warp } = this;
      const { warpX, warpY } = (0, import_lonlat_tile.getTileWarpXY)(x, y, z, warp);
      const { signal } = this.abortController;
      const params = { x: warpX, y: warpY, z, bounds, tileSize, signal, warp };
      tileData = await getData(params, this);
    } catch (err) {
      error = err;
    }
    if (loadDataId !== this.loadDataId) {
      return;
    }
    if (this.isCancelled && !tileData) {
      return;
    }
    if (error || !tileData) {
      this.loadStatus = import_types.LoadTileDataStatus.Failure;
      onError(error, this);
      return;
    }
    this.loadStatus = import_types.LoadTileDataStatus.Loaded;
    this.data = tileData;
    onLoad(this);
  }
  // 重新请求瓦片数据
  reloadData(params) {
    if (this.isLoading) {
      this.abortLoad();
    }
    this.loadData(params);
  }
  // 取消请求瓦片数据
  abortLoad() {
    if (this.isLoaded || this.isCancelled) {
      return;
    }
    this.loadStatus = import_types.LoadTileDataStatus.Cancelled;
    this.abortController.abort();
    if (this.xhrCancel) {
      this.xhrCancel();
    }
  }
};
// Annotate the CommonJS export names for ESM import in node:
0 && (module.exports = {
  SourceTile
});
