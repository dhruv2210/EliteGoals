{"version":3,"sources":["../../../src/components/framegraph/System.ts"],"names":["FrameGraphSystem","IDENTIFIER","RenderEngine","passNodes","resourceNodes","frameGraphPasses","views","compile","executePassNodes","forEach","pass","tearDown","reset","name","setup","execute","frameGraphPass","FrameGraphPass","passNode","PassNode","push","find","p","refCount","writes","length","hasSideEffect","reads","handle","index","readerCount","stack","node","pNode","pop","writer","resource","r","refs","pResource","first","last","priority","resoureNode","pFirst","pLast","devirtualize","destroy","entries","preExecuteDevirtualize","engine","preExecuteDestroy","postExecuteDevirtualize","postExecuteDestroy","resourceEntry","resourceNode","ResourceNode","version","fgh","FrameGraphHandle","descriptor","ResourceEntry","createResourceNode","input","addPass","fg","read"],"mappings":"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","sourcesContent":["import { inject, injectable } from 'inversify';\nimport { ISystem, IView } from '../..';\nimport { IDENTIFIER } from '../../identifier';\nimport { IRendererService } from '../renderer/IRendererService';\nimport { FrameGraphHandle, TextureDescriptor } from './FrameGraphHandle';\nimport { FrameGraphPass } from './FrameGraphPass';\nimport { PassNode } from './PassNode';\nimport { ResourceEntry } from './ResourceEntry';\nimport { ResourceNode } from './ResourceNode';\n\n/**\n * ported from FrameGraph implemented by SakuraRender\n * @see https://zhuanlan.zhihu.com/p/98572442\n * @see https://github.com/SaeruHikari/Sakura/blob/RenderGraph/SakuraCore/Source/Framework/GraphicTypes/FrameGraph/SakuraFrameGraph.cpp\n */\n@injectable()\nexport class FrameGraphSystem implements ISystem {\n  public passNodes: PassNode[] = [];\n\n  public resourceNodes: ResourceNode[] = [];\n\n  public frameGraphPasses: Array<FrameGraphPass<any>> = [];\n\n  @inject(IDENTIFIER.RenderEngine)\n  private readonly engine: IRendererService;\n\n  public async execute(views: IView[]) {\n    // this.engine.beginFrame();\n    this.compile();\n    await this.executePassNodes(views);\n    // this.engine.endFrame();\n  }\n\n  public tearDown() {\n    this.frameGraphPasses.forEach((pass) => {\n      if (pass.tearDown) {\n        pass.tearDown();\n      }\n    });\n    this.reset();\n  }\n\n  public addPass<PassData>(\n    name: string,\n    setup: (\n      fg: FrameGraphSystem,\n      passNode: PassNode,\n      pass: FrameGraphPass<PassData>,\n    ) => void,\n    execute: (\n      fg: FrameGraphSystem,\n      pass: FrameGraphPass<PassData>,\n      views: IView[],\n    ) => Promise<void>,\n    tearDown?: () => void,\n  ) {\n    const frameGraphPass = new FrameGraphPass<PassData>();\n    frameGraphPass.execute = execute;\n    if (tearDown) {\n      frameGraphPass.tearDown = tearDown;\n    }\n    frameGraphPass.name = name;\n\n    const passNode = new PassNode();\n    passNode.name = name;\n    this.passNodes.push(passNode);\n\n    this.frameGraphPasses.push(frameGraphPass);\n\n    setup(this, passNode, frameGraphPass);\n\n    return frameGraphPass;\n  }\n\n  public getPass<T>(name: string): FrameGraphPass<T> | undefined {\n    return this.frameGraphPasses.find((p) => p.name === name);\n  }\n\n  public compile() {\n    for (const pass of this.passNodes) {\n      pass.refCount = pass.writes.length + (pass.hasSideEffect ? 1 : 0);\n\n      pass.reads.forEach((handle) => {\n        this.resourceNodes[handle.index].readerCount++;\n      });\n    }\n\n    const stack: ResourceNode[] = [];\n    for (const node of this.resourceNodes) {\n      if (node.readerCount === 0) {\n        stack.push(node);\n      }\n    }\n    while (stack.length) {\n      const pNode = stack.pop();\n      const writer = pNode && pNode.writer;\n      if (writer) {\n        if (--writer.refCount === 0) {\n          // this pass is culled\n          // assert(!writer->hasSideEffect);\n          for (const resource of writer.reads) {\n            const r = this.resourceNodes[resource.index];\n            if (--r.readerCount === 0) {\n              stack.push(r);\n            }\n          }\n        }\n      }\n    }\n\n    // update the final reference counts\n    this.resourceNodes.forEach((node) => {\n      node.resource.refs += node.readerCount;\n    });\n\n    for (const pass of this.passNodes) {\n      if (!pass.refCount) {\n        continue;\n      }\n      for (const resource of pass.reads) {\n        const pResource = this.resourceNodes[resource.index].resource;\n        pResource.first = pResource.first ? pResource.first : pass;\n        pResource.last = pass;\n      }\n      for (const resource of pass.writes) {\n        const pResource = this.resourceNodes[resource.index].resource;\n        pResource.first = pResource.first ? pResource.first : pass;\n        pResource.last = pass;\n      }\n    }\n\n    for (let priority = 0; priority < 2; priority++) {\n      for (const resoureNode of this.resourceNodes) {\n        const resource = resoureNode.resource;\n        if (resource.priority === priority && resource.refs) {\n          const pFirst = resource.first;\n          const pLast = resource.last;\n          if (pFirst && pLast) {\n            pFirst.devirtualize.push(resource);\n            pLast.destroy.push(resource);\n          }\n        }\n      }\n    }\n  }\n\n  public async executePassNodes(views: IView[]) {\n    for (const [index, node] of this.passNodes.entries()) {\n      if (node.refCount) {\n        for (const resource of node.devirtualize) {\n          resource.preExecuteDevirtualize(this.engine);\n        }\n\n        for (const resource of node.destroy) {\n          resource.preExecuteDestroy(this.engine);\n        }\n\n        await this.frameGraphPasses[index].execute(\n          this,\n          this.frameGraphPasses[index],\n          views,\n        );\n\n        for (const resource of node.devirtualize) {\n          resource.postExecuteDevirtualize(this.engine);\n        }\n\n        for (const resource of node.destroy) {\n          resource.postExecuteDestroy(this.engine);\n        }\n      }\n    }\n    this.reset();\n  }\n\n  public reset() {\n    this.passNodes = [];\n    this.resourceNodes = [];\n    this.frameGraphPasses = [];\n  }\n\n  public getResourceNode(r: FrameGraphHandle) {\n    return this.resourceNodes[r.index];\n  }\n\n  public createResourceNode(resourceEntry: ResourceEntry) {\n    const resourceNode = new ResourceNode();\n    resourceNode.resource = resourceEntry;\n    resourceNode.version = resourceEntry.version;\n\n    this.resourceNodes.push(resourceNode);\n\n    const fgh = new FrameGraphHandle();\n    fgh.index = this.resourceNodes.length - 1;\n\n    return fgh;\n  }\n\n  public createTexture(\n    passNode: PassNode,\n    name: string,\n    descriptor: TextureDescriptor,\n  ) {\n    const resource = new ResourceEntry();\n    resource.name = name;\n    resource.descriptor = descriptor;\n    return this.createResourceNode(resource);\n  }\n\n  public createRenderTarget(\n    passNode: PassNode,\n    name: string,\n    descriptor: TextureDescriptor,\n  ) {\n    const resource = new ResourceEntry();\n    resource.name = name;\n    resource.descriptor = descriptor;\n    return this.createResourceNode(resource);\n  }\n\n  public present(input: FrameGraphHandle) {\n    this.addPass<{}>(\n      'Present',\n      (fg, passNode) => {\n        passNode.read(input);\n        passNode.hasSideEffect = true;\n      },\n      async () => {\n        // 不需要执行\n      },\n    );\n  }\n}\n"],"file":"System.js"}