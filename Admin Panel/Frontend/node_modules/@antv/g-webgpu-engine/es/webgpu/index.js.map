{"version":3,"sources":["../../src/webgpu/index.ts"],"names":["isSafari","WebGPUConstants","injectable","glslang","WebGPUAttribute","WebGPUBuffer","WebGPUComputeModel","WebGPUElements","WebGPUFramebuffer","WebGPUModel","WebGPUTexture2D","WebGPUEngine","supportWebGPU","useWGSL","options","canvas","context","adapter","device","swapChain","mainPassSampleCount","mainTexture","depthTexture","mainColorAttachments","mainTextureExtends","mainDepthAttachment","uploadEncoder","renderEncoder","computeEncoder","renderTargetEncoder","commandBuffers","Array","fill","undefined","currentRenderPass","mainRenderPass","currentRenderTargetViewDescriptor","currentComputePass","bundleEncoder","tempBuffers","currentRenderTarget","uploadEncoderDescriptor","label","renderEncoderDescriptor","renderTargetEncoderDescriptor","computeEncoderDescriptor","pipelines","computePipelines","defaultSampleCount","clearDepthValue","clearStencilValue","transientViewport","x","Infinity","y","width","height","cachedViewport","clear","framebuffer","color","depth","stencil","supportCompute","startComputePass","endRenderTargetRenderPass","startRenderTargetRenderPass","loadValue","LoadOp","Load","depthLoadValue","stencilLoadValue","endMainRenderPass","startMainRenderPass","createModel","model","init","createAttribute","createBuffer","createElements","createTexture2D","createFramebuffer","useFramebuffer","drawCommands","unbindFramebuffer","dimension","TextureViewDimension","E2d","arrayLayerCount","aspect","TextureAspect","All","createComputeModel","getCanvas","getGLContext","Error","viewport","renderPass","getCurrentRenderPass","setViewport","readPixels","config","antialiasing","initGlslang","initContextAndSwapChain","initMainAttachments","scissor","destroy","forEach","buffer","createCommandEncoder","endComputePass","finish","getQueue","submit","filter","defaultQueue","navigator","gpu","requestAdapter","requestDevice","getContext","configureSwapChain","format","swapChainFormat","usage","TextureUsage","OutputAttachment","CopySrc","mainTextureDescriptor","size","mipLevelCount","sampleCount","TextureDimension","TextureFormat","BGRA8Unorm","createTexture","attachment","createDefaultView","createView","storeOp","StoreOp","Store","getCurrentTexture","depthTextureDescriptor","Depth24PlusStencil8","depthStoreOp","stencilStoreOp","beginComputePass","resolveTarget","beginRenderPass","colorAttachments","depthStencilAttachment","renderTarget","clearColor","clearDepth","clearStencil","gpuTexture","get","texture","colorTextureView","depthStencilTexture","depthStencilTextureView","endPass","resetCachedViewport"],"mappings":"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","sourcesContent":["/**\n * implements renderService with WebGPU API\n * @see https://webgpu.io/\n * @see https://github.com/BabylonJS/Babylon.js/blob/WebGPU/src/Engines/webgpuEngine.ts\n */\nimport {\n  GLSLContext,\n  IAttribute,\n  IAttributeInitializationOptions,\n  IBuffer,\n  IBufferInitializationOptions,\n  IClearOptions,\n  IElements,\n  IElementsInitializationOptions,\n  IFramebuffer,\n  IFramebufferInitializationOptions,\n  IModel,\n  IModelInitializationOptions,\n  IReadPixelsOptions,\n  IRendererConfig,\n  IRendererService,\n  isSafari,\n  ITexture2D,\n  ITexture2DInitializationOptions,\n  IViewport,\n} from '@antv/g-webgpu-core';\n// import { Glslang } from '@webgpu/glslang/dist/web-devel/glslang.onefile';\nimport * as WebGPUConstants from '@webgpu/types/dist/constants';\nimport { vec4 } from 'gl-matrix';\nimport { injectable } from 'inversify';\nimport glslang from './glslang';\nimport WebGPUAttribute from './WebGPUAttribute';\nimport WebGPUBuffer from './WebGPUBuffer';\nimport WebGPUComputeModel from './WebGPUComputeModel';\nimport WebGPUElements from './WebGPUElements';\nimport WebGPUFramebuffer from './WebGPUFramebuffer';\nimport WebGPUModel from './WebGPUModel';\nimport WebGPUTexture2D from './WebGPUTexture2D';\n\ntype Omit<T, K extends keyof T> = Pick<T, Exclude<keyof T, K>>;\ntype WithOptional<T, K extends keyof T> = Omit<T, K> & Partial<Pick<T, K>>;\n\n/**\n * regl renderer\n */\n@injectable()\nexport class WebGPUEngine implements IRendererService {\n  public supportWebGPU = true;\n  public useWGSL = false;\n\n  public options: IRendererConfig;\n  public canvas: HTMLCanvasElement;\n  public context: GPUCanvasContext;\n  public glslang: any;\n  public adapter: GPUAdapter;\n  public device: GPUDevice;\n  public swapChain: GPUSwapChain;\n\n  public mainPassSampleCount: number;\n\n  public mainTexture: GPUTexture;\n  public depthTexture: GPUTexture;\n  public mainColorAttachments: GPURenderPassColorAttachmentDescriptor[];\n  public mainTextureExtends: GPUExtent3D;\n  public mainDepthAttachment: GPURenderPassDepthStencilAttachmentDescriptor;\n\n  // Frame Life Cycle (recreated each frame)\n  public uploadEncoder: GPUCommandEncoder;\n  public renderEncoder: GPUCommandEncoder;\n  public computeEncoder: GPUCommandEncoder;\n  public renderTargetEncoder: GPUCommandEncoder;\n  public commandBuffers: GPUCommandBuffer[] = new Array(4).fill(undefined);\n\n  // Frame Buffer Life Cycle (recreated for each render target pass)\n  public currentRenderPass: GPURenderPassEncoder | null = null;\n  public mainRenderPass: GPURenderPassEncoder | null = null;\n  public currentRenderTargetViewDescriptor: GPUTextureViewDescriptor;\n  public currentComputePass: GPUComputePassEncoder | null = null;\n  public bundleEncoder: GPURenderBundleEncoder | null;\n  public tempBuffers: GPUBuffer[] = [];\n  public currentRenderTarget: WebGPUFramebuffer | null = null;\n\n  public readonly uploadEncoderDescriptor = { label: 'upload' };\n  public readonly renderEncoderDescriptor = { label: 'render' };\n  public readonly renderTargetEncoderDescriptor = { label: 'renderTarget' };\n  public readonly computeEncoderDescriptor = { label: 'compute' };\n\n  /**\n   * 通过名称访问\n   */\n  private pipelines: {\n    [pipelineName: string]: GPURenderPipeline;\n  } = {};\n  private computePipelines: {\n    [pipelineName: string]: GPUComputePipeline;\n  } = {};\n\n  private readonly defaultSampleCount = 4;\n  private readonly clearDepthValue = 1;\n  private readonly clearStencilValue = 0;\n  private transientViewport: IViewport = {\n    x: Infinity,\n    y: 0,\n    width: 0,\n    height: 0,\n  };\n  private cachedViewport: IViewport = {\n    x: 0,\n    y: 0,\n    width: 0,\n    height: 0,\n  };\n\n  public isFloatSupported() {\n    return true;\n  }\n\n  public async init(config: IRendererConfig): Promise<void> {\n    this.canvas = config.canvas!;\n    this.options = config;\n    this.useWGSL = !!config.useWGSL;\n    this.mainPassSampleCount = config.antialiasing\n      ? this.defaultSampleCount\n      : 1;\n\n    await this.initGlslang();\n    this.initContextAndSwapChain();\n    this.initMainAttachments();\n  }\n\n  public setScissor(\n    scissor: Partial<{\n      enable: boolean;\n      box: { x: number; y: number; width: number; height: number };\n    }>,\n  ): void {\n    throw new Error('Method not implemented.');\n  }\n\n  public clear = (options: IClearOptions): void => {\n    const { framebuffer, color, depth, stencil } = options;\n\n    if (this.options.supportCompute) {\n      this.startComputePass();\n    }\n\n    // We need to recreate the render pass so that the new parameters for clear color / depth / stencil are taken into account\n    if (this.currentRenderTarget) {\n      if (this.currentRenderPass) {\n        this.endRenderTargetRenderPass();\n      }\n      this.startRenderTargetRenderPass(\n        this.currentRenderTarget!,\n        color ? color : null,\n        !!depth,\n        !!stencil,\n      );\n    } else {\n      // if (this.useReverseDepthBuffer) {\n      //     this._depthCullingState.depthFunc = Constants.GREATER;\n      // }\n\n      this.mainColorAttachments[0].loadValue = color\n        ? color\n        : WebGPUConstants.LoadOp.Load;\n\n      this.mainDepthAttachment.depthLoadValue = depth\n        ? depth\n        : WebGPUConstants.LoadOp.Load;\n      this.mainDepthAttachment.stencilLoadValue = stencil\n        ? this.clearStencilValue\n        : WebGPUConstants.LoadOp.Load;\n\n      if (this.mainRenderPass) {\n        this.endMainRenderPass();\n      }\n\n      this.startMainRenderPass();\n    }\n  };\n\n  public createModel = async (\n    options: IModelInitializationOptions,\n  ): Promise<IModel> => {\n    const model = new WebGPUModel(this, options);\n    await model.init();\n    return model;\n  };\n\n  public createAttribute = (\n    options: IAttributeInitializationOptions,\n  ): IAttribute => {\n    return new WebGPUAttribute(this, options);\n  };\n\n  public createBuffer = (options: IBufferInitializationOptions): IBuffer => {\n    return new WebGPUBuffer(this, options);\n  };\n\n  public createElements = (\n    options: IElementsInitializationOptions,\n  ): IElements => {\n    return new WebGPUElements(this, options);\n  };\n\n  public createTexture2D = (\n    options: ITexture2DInitializationOptions,\n  ): ITexture2D => {\n    return new WebGPUTexture2D(this, options);\n  };\n\n  public createFramebuffer = (\n    options: IFramebufferInitializationOptions,\n  ): IFramebuffer => {\n    return new WebGPUFramebuffer(this, options);\n  };\n\n  public useFramebuffer = (\n    framebuffer: IFramebuffer | null,\n    drawCommands: () => void,\n  ): void => {\n    // bind\n    if (this.currentRenderTarget) {\n      this.unbindFramebuffer(this.currentRenderTarget);\n    }\n    this.currentRenderTarget = framebuffer as WebGPUFramebuffer;\n\n    // TODO: use mipmap options in framebuffer\n    this.currentRenderTargetViewDescriptor = {\n      dimension: WebGPUConstants.TextureViewDimension.E2d,\n      // mipLevelCount: bindWithMipMaps ? WebGPUTextureHelper.computeNumMipmapLevels(texture.width, texture.height) - lodLevel : 1,\n      // baseArrayLayer: faceIndex,\n      // baseMipLevel: lodLevel,\n      arrayLayerCount: 1,\n      aspect: WebGPUConstants.TextureAspect.All,\n    };\n\n    this.currentRenderPass = null;\n\n    drawCommands();\n  };\n\n  public createComputeModel = async (context: GLSLContext) => {\n    const model = new WebGPUComputeModel(this, context);\n    await model.init();\n    return model;\n  };\n\n  public getCanvas = (): HTMLCanvasElement => {\n    return this.canvas;\n  };\n\n  public getGLContext = (): WebGLRenderingContext => {\n    throw new Error('Method not implemented.');\n  };\n\n  public viewport = ({\n    x,\n    y,\n    width,\n    height,\n  }: {\n    x: number;\n    y: number;\n    width: number;\n    height: number;\n  }): void => {\n    if (!this.currentRenderPass) {\n      // call viewport() before current render pass created\n      this.transientViewport = { x, y, width, height };\n    } else if (this.transientViewport.x !== Infinity) {\n      const renderPass = this.getCurrentRenderPass();\n      // @see https://gpuweb.github.io/gpuweb/#dom-gpurenderpassencoder-setviewport\n      renderPass.setViewport(\n        this.transientViewport.x,\n        this.transientViewport.y,\n        this.transientViewport.width,\n        this.transientViewport.height,\n        0,\n        1,\n      );\n    } else if (\n      x !== this.cachedViewport.x ||\n      y !== this.cachedViewport.y ||\n      width !== this.cachedViewport.width ||\n      height !== this.cachedViewport.height\n    ) {\n      this.cachedViewport = { x, y, width, height };\n      const renderPass = this.getCurrentRenderPass();\n      renderPass.setViewport(x, y, width, height, 0, 1);\n    }\n  };\n\n  public readPixels = (options: IReadPixelsOptions): Uint8Array => {\n    throw new Error('Method not implemented.');\n  };\n\n  public destroy(): void {\n    if (this.mainTexture) {\n      this.mainTexture.destroy();\n    }\n    if (this.depthTexture) {\n      this.depthTexture.destroy();\n    }\n    this.tempBuffers.forEach((buffer) => buffer.destroy());\n    this.tempBuffers = [];\n  }\n\n  public beginFrame() {\n    this.uploadEncoder = this.device.createCommandEncoder(\n      this.uploadEncoderDescriptor,\n    );\n    this.renderEncoder = this.device.createCommandEncoder(\n      this.renderEncoderDescriptor,\n    );\n    this.renderTargetEncoder = this.device.createCommandEncoder(\n      this.renderTargetEncoderDescriptor,\n    );\n    if (this.options.supportCompute) {\n      this.computeEncoder = this.device.createCommandEncoder(\n        this.computeEncoderDescriptor,\n      );\n    }\n  }\n\n  public endFrame() {\n    if (this.options.supportCompute) {\n      this.endComputePass();\n    }\n\n    this.endMainRenderPass();\n\n    this.commandBuffers[0] = this.uploadEncoder.finish();\n    this.commandBuffers[1] = this.renderEncoder.finish();\n    if (this.options.supportCompute) {\n      this.commandBuffers[2] = this.computeEncoder.finish();\n    }\n    this.commandBuffers[3] = this.renderTargetEncoder.finish();\n\n    if (isSafari) {\n      this.device\n        // @ts-ignore\n        .getQueue()\n        .submit(this.commandBuffers.filter((buffer) => buffer));\n    } else {\n      this.device.defaultQueue.submit(\n        this.commandBuffers.filter((buffer) => buffer),\n      );\n    }\n  }\n\n  public getCurrentRenderPass(): GPURenderPassEncoder {\n    if (this.currentRenderTarget && !this.currentRenderPass) {\n      this.startRenderTargetRenderPass(\n        this.currentRenderTarget,\n        null,\n        false,\n        false,\n      );\n    } else if (!this.currentRenderPass) {\n      this.startMainRenderPass();\n    }\n\n    return this.currentRenderPass!;\n  }\n\n  private async initGlslang() {\n    this.glslang = await glslang();\n    this.adapter = (await navigator?.gpu?.requestAdapter()) as GPUAdapter;\n    this.device = (await this.adapter.requestDevice()) as GPUDevice;\n  }\n\n  private initContextAndSwapChain() {\n    this.context = (this.canvas.getContext(\n      isSafari ? 'gpu' : 'gpupresent',\n    ) as unknown) as GPUCanvasContext;\n    this.swapChain = this.context.configureSwapChain({\n      device: this.device,\n      format: this.options.swapChainFormat!,\n      usage:\n        WebGPUConstants.TextureUsage.OutputAttachment |\n        WebGPUConstants.TextureUsage.CopySrc,\n    });\n  }\n\n  private initMainAttachments() {\n    this.mainTextureExtends = {\n      width: this.canvas.width,\n      height: this.canvas.height,\n      depth: 1,\n    };\n\n    if (this.options.antialiasing) {\n      const mainTextureDescriptor = {\n        size: this.mainTextureExtends,\n        // TODO: arrayLayerCount is deprecated: use size.depth\n        // arrayLayerCount: 1,\n        mipLevelCount: 1,\n        sampleCount: this.mainPassSampleCount,\n        dimension: WebGPUConstants.TextureDimension.E2d,\n        format: WebGPUConstants.TextureFormat.BGRA8Unorm,\n        usage: WebGPUConstants.TextureUsage.OutputAttachment,\n      };\n\n      if (this.mainTexture) {\n        this.mainTexture.destroy();\n      }\n      this.mainTexture = this.device.createTexture(mainTextureDescriptor);\n      this.mainColorAttachments = [\n        {\n          attachment: isSafari\n            ? // @ts-ignore\n              this.mainTexture.createDefaultView()\n            : this.mainTexture.createView(),\n          loadValue: [0, 0, 0, 1],\n          storeOp: WebGPUConstants.StoreOp.Store,\n        },\n      ];\n    } else {\n      this.mainColorAttachments = [\n        {\n          attachment: isSafari\n            ? // @ts-ignore\n              this.swapChain.getCurrentTexture().createDefaultView()\n            : this.swapChain.getCurrentTexture().createView(),\n          loadValue: [0, 0, 0, 1],\n          storeOp: WebGPUConstants.StoreOp.Store,\n        },\n      ];\n    }\n\n    const depthTextureDescriptor = {\n      size: this.mainTextureExtends,\n      // arrayLayerCount: 1,\n      mipLevelCount: 1,\n      sampleCount: this.mainPassSampleCount,\n      dimension: WebGPUConstants.TextureDimension.E2d,\n      format: isSafari\n        ? 'depth32float-stencil8'\n        : WebGPUConstants.TextureFormat.Depth24PlusStencil8,\n      usage: WebGPUConstants.TextureUsage.OutputAttachment,\n    };\n\n    if (this.depthTexture) {\n      this.depthTexture.destroy();\n    }\n\n    this.depthTexture = this.device.createTexture(\n      // @ts-ignore\n      depthTextureDescriptor,\n    );\n    this.mainDepthAttachment = {\n      attachment: isSafari\n        ? // @ts-ignore\n          this.depthTexture.createDefaultView()\n        : this.depthTexture.createView(),\n      depthLoadValue: this.clearDepthValue,\n      depthStoreOp: WebGPUConstants.StoreOp.Store,\n      stencilLoadValue: this.clearStencilValue,\n      stencilStoreOp: WebGPUConstants.StoreOp.Store,\n    };\n  }\n\n  private startComputePass() {\n    if (this.currentComputePass) {\n      this.endComputePass();\n    }\n\n    this.currentComputePass = this.computeEncoder.beginComputePass();\n  }\n\n  private startMainRenderPass() {\n    if (this.currentRenderPass && !this.currentRenderTarget) {\n      this.endMainRenderPass();\n    }\n\n    // Resolve in case of MSAA\n    if (this.options.antialiasing) {\n      this.mainColorAttachments[0].resolveTarget = isSafari\n        ? // @ts-ignore\n          this.swapChain.getCurrentTexture().createDefaultView()\n        : this.swapChain.getCurrentTexture().createView();\n    } else {\n      this.mainColorAttachments[0].attachment = isSafari\n        ? // @ts-ignore\n          this.swapChain.getCurrentTexture().createDefaultView()\n        : this.swapChain.getCurrentTexture().createView();\n    }\n\n    this.currentRenderPass = this.renderEncoder.beginRenderPass({\n      colorAttachments: this.mainColorAttachments,\n      depthStencilAttachment: this.mainDepthAttachment, // TODO: use framebuffer's depth & stencil\n    });\n\n    this.mainRenderPass = this.currentRenderPass;\n\n    if (this.cachedViewport) {\n      this.viewport(this.cachedViewport);\n    }\n  }\n\n  private startRenderTargetRenderPass(\n    renderTarget: WebGPUFramebuffer,\n    clearColor: [number, number, number, number] | null,\n    clearDepth: boolean,\n    clearStencil: boolean = false,\n  ) {\n    const gpuTexture = renderTarget.get().color?.texture;\n    let colorTextureView: GPUTextureView;\n    if (gpuTexture) {\n      colorTextureView = gpuTexture.createView(\n        this.currentRenderTargetViewDescriptor,\n      );\n    }\n\n    const depthStencilTexture = renderTarget.get().depth?.texture;\n    let depthStencilTextureView;\n    if (depthStencilTexture) {\n      depthStencilTextureView = depthStencilTexture.createView();\n    }\n\n    const renderPass = this.renderTargetEncoder.beginRenderPass({\n      colorAttachments: [\n        {\n          attachment: colorTextureView!,\n          loadValue:\n            clearColor !== null ? clearColor : WebGPUConstants.LoadOp.Load,\n          storeOp: WebGPUConstants.StoreOp.Store,\n        },\n      ],\n      depthStencilAttachment:\n        depthStencilTexture && depthStencilTextureView\n          ? {\n              attachment: depthStencilTextureView,\n              depthLoadValue: clearDepth\n                ? this.clearDepthValue\n                : WebGPUConstants.LoadOp.Load,\n              depthStoreOp: WebGPUConstants.StoreOp.Store,\n              stencilLoadValue: clearStencil\n                ? this.clearStencilValue\n                : WebGPUConstants.LoadOp.Load,\n              stencilStoreOp: WebGPUConstants.StoreOp.Store,\n            }\n          : undefined,\n    });\n\n    this.currentRenderPass = renderPass;\n\n    if (this.cachedViewport) {\n      this.viewport(this.cachedViewport);\n    }\n\n    // TODO WEBGPU set the scissor rect and the stencil reference value\n  }\n\n  private endMainRenderPass() {\n    if (\n      this.currentRenderPass === this.mainRenderPass &&\n      this.currentRenderPass !== null\n    ) {\n      this.currentRenderPass.endPass();\n      this.resetCachedViewport();\n      this.currentRenderPass = null;\n      this.mainRenderPass = null;\n    }\n  }\n\n  private endComputePass() {\n    if (this.currentComputePass) {\n      this.currentComputePass.endPass();\n      this.currentComputePass = null;\n    }\n  }\n\n  private endRenderTargetRenderPass() {\n    if (this.currentRenderPass) {\n      this.currentRenderPass.endPass();\n      this.resetCachedViewport();\n    }\n  }\n\n  private resetCachedViewport() {\n    this.cachedViewport = {\n      x: 0,\n      y: 0,\n      width: 0,\n      height: 0,\n    };\n  }\n\n  private unbindFramebuffer(framebuffer: WebGPUFramebuffer) {\n    // unbind\n    if (\n      this.currentRenderPass &&\n      this.currentRenderPass !== this.mainRenderPass\n    ) {\n      this.endRenderTargetRenderPass();\n    }\n\n    this.transientViewport.x = Infinity;\n    this.currentRenderTarget = null;\n\n    // if (texture.generateMipMaps && !disableGenerateMipMaps && !texture.isCube) {\n    //   this._generateMipmaps(texture);\n    // }\n\n    this.currentRenderPass = this.mainRenderPass;\n  }\n}\n"],"file":"index.js"}