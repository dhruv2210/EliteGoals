!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@antv/x6"),require("react"),require("react-dom")):"function"==typeof define&&define.amd?define(["exports","@antv/x6","react","react-dom"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).X6ReactShape={},t.X6,t.React,t.ReactDom)}(this,(function(t,e,n,r){"use strict";function o(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var i=o(n),c=o(r),a=e.Registry.create({type:"react componnet"});e.Graph.registerReactComponent=a.register,e.Graph.unregisterReactComponent=a.unregister,e.Graph.Hook.prototype.getReactComponent=function(t){var n=this.options.getReactComponent;if("function"==typeof n){var r=e.FunctionExt.call(n,this.graph,t);if(null!=r)return r}var o=t.getComponent();if("string"==typeof o){var i=a.get(o);if(null==i)return a.onNotFound(o);o=i}return o};
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation.

    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.

    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */
var u=function(t,e){return(u=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(t,e)};function p(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function n(){this.constructor=t}u(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}var l,f,s,d,h=function(){return(h=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var o in e=arguments[n])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t}).apply(this,arguments)};function m(t,e,n){if(n||2===arguments.length)for(var r,o=0,i=e.length;o<i;o++)!r&&o in e||(r||(r=Array.prototype.slice.call(e,0,o)),r[o]=e[o]);return t.concat(r||Array.prototype.slice.call(e))}t.ReactShape=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return p(e,t),Object.defineProperty(e.prototype,"component",{get:function(){return this.getComponent()},set:function(t){this.setComponent(t)},enumerable:!1,configurable:!0}),e.prototype.getComponent=function(){return this.store.get("component")},e.prototype.setComponent=function(t,e){return void 0===e&&(e={}),null==t?this.removeComponent(e):this.store.set("component",t,e),this},e.prototype.removeComponent=function(t){return void 0===t&&(t={}),this.store.remove("component",t),this},e}(e.Node),function(t){function n(t,n,r){void 0===r&&(r="rect");var o=[],i=n?e.Markup.getForeignObjectMarkup():{tagName:"g",selector:"content"};return t?o.push(i):o.push.apply(o,[{tagName:r,selector:"body"},i,{tagName:"text",selector:"label"}]),o}t.config({view:"react-shape-view",markup:n(!1,!0),attrs:{body:{fill:"none",stroke:"none",refWidth:"100%",refHeight:"100%"},fo:{refWidth:"100%",refHeight:"100%"},label:{fontSize:14,fill:"#333",refX:"50%",refY:"50%",textAnchor:"middle",textVerticalAnchor:"middle"}},propHooks:function(t){if(null==t.markup){var r=t.primer,o=!1!==t.useForeignObject;if(r&&"rect"!==r){t.markup=n(!1,o,r);var i={};"circle"===r?i={refCx:"50%",refCy:"50%",refR:"50%"}:"ellipse"===r&&(i={refCx:"50%",refCy:"50%",refRx:"50%",refRy:"50%"}),t.attrs=e.ObjectExt.merge({},{body:h({refWidth:null,refHeight:null},i)},t.attrs||{})}else t.simple&&(t.markup=n(!0,o),t.attrs=e.ObjectExt.merge({},{body:null,label:null},t.attrs||{}))}return t}}),e.Node.registry.register("react-shape",t,!0)}(t.ReactShape||(t.ReactShape={})),t.Portal=void 0,l=t.Portal||(t.Portal={}),s=!1,d=function(t,e){var n=e.payload;switch(e.type){case"add":return(r=t.findIndex((function(t){return t.id===n.id})))>=0?(t[r]=n,m([],t,!0)):m(m([],t,!0),[n],!1);case"remove":var r;if((r=t.findIndex((function(t){return t.id===n.id})))>=0){var o=m([],t,!0);return o.splice(r,1),o}}return t},l.connect=function(t,e){s&&f({type:"add",payload:{id:t,portal:e}})},l.disconnect=function(t){s&&f({type:"remove",payload:{id:t}})},l.isActive=function(){return s},l.getProvider=function(){return function(){s=!0;var t=n.useReducer(d,[]),e=t[0],r=t[1];return f=r,i.default.createElement(i.default.Fragment,{children:e.map((function(t){return t.portal}))})}};var y,g=function(t){function n(e){var r=t.call(this,e)||this;return r.scheduledAnimationFrame=!1,r.throttleUpdateFunc=function(){r.scheduledAnimationFrame||(r.scheduledAnimationFrame=!0,window.requestAnimationFrame((function(){r.setState((function(t){return r.scheduledAnimationFrame=!1,{tick:t.tick+1}}))})))},r.onChange=function(t){n.throttleChangeTypes.includes(t.key)?r.throttleUpdateFunc():r.setState({tick:r.state.tick+1})},r.state={tick:0},r}return p(n,t),n.prototype.componentDidMount=function(){this.props.node.on("change:*",this.onChange)},n.prototype.componentWillUnmount=function(){this.props.node.off("change:*",this.onChange)},n.prototype.clone=function(t){var e=this.props.node;return"string"==typeof t.type?i.default.cloneElement(t):i.default.cloneElement(t,{node:e})},n.prototype.render=function(){var t=this.props,n=t.graph,r=t.node,o=t.component;if(i.default.isValidElement(o))return this.clone(o);if("function"==typeof o){var c=e.FunctionExt.call(o,n,r);if(i.default.isValidElement(c))return this.clone(c)}return o},n.throttleChangeTypes=["position","size"],n}(i.default.PureComponent);t.ReactShapeView=function(n){function r(){return null!==n&&n.apply(this,arguments)||this}return p(r,n),r.prototype.init=function(){var e=this;n.prototype.init.call(this),this.cell.on("removed",(function(){t.Portal.disconnect(e.cell.id)}))},r.prototype.getComponentContainer=function(){return!1===this.cell.prop("useForeignObject")?this.selectors.content:this.selectors.foContent},r.prototype.confirmUpdate=function(t){var o=this,i=n.prototype.confirmUpdate.call(this,t);return this.handleAction(i,r.action,(function(){e.Scheduler?e.Scheduler.scheduleTask((function(){o.renderReactComponent()})):o.renderReactComponent()}))},r.prototype.renderReactComponent=function(){this.unmountReactComponent();var e=this.getComponentContainer(),n=this.cell,r=this.graph;if(e){var o=this.graph.hook.getReactComponent(n),a=i.default.createElement(g,{graph:r,node:n,component:o});t.Portal.isActive()?t.Portal.connect(this.cell.id,c.default.createPortal(a,e)):c.default.render(a,e)}},r.prototype.unmountReactComponent=function(){var t=this.getComponentContainer();return t&&c.default.unmountComponentAtNode(t),t},r.prototype.unmount=function(){return t.Portal.disconnect(this.cell.id),this.unmountReactComponent(),n.prototype.unmount.call(this),this},r}(e.NodeView),(y=t.ReactShapeView||(t.ReactShapeView={})).action="react",y.config({bootstrap:[y.action],actions:{component:y.action}}),e.NodeView.registry.register("react-shape-view",y,!0);var v="react";function C(t){var r,o,a={current:function(){}};function u(t){o(t)}var l=function(t){function n(){return null!==t&&t.apply(this,arguments)||this}return p(n,t),n.prototype.init=function(){var e=this;t.prototype.init.call(this),this.cell.on("removed",(function(){u(e.cell.id)}))},n.prototype.getComponentContainer=function(){return!1===this.cell.prop("useForeignObject")?this.selectors.content:this.selectors.foContent},n.prototype.confirmUpdate=function(e){var n=this,r=t.prototype.confirmUpdate.call(this,e);return this.handleAction(r,v,(function(){return n.renderReactComponent()}))},n.prototype.renderReactComponent=function(){this.unmountReactComponent();var t,e,n=this.getComponentContainer(),o=this.cell,a=this.graph;if(n){var u=this.graph.hook.getReactComponent(o),p=i.default.createElement(g,{graph:a,node:o,component:u});t=this.cell.id,e=c.default.createPortal(p,n),r({id:t,portal:e})}},n.prototype.unmountReactComponent=function(){var t=this.getComponentContainer();return t&&c.default.unmountComponentAtNode(t),t},n.prototype.onMouseDown=function(e,n,r){var o=e.target;if("input"===o.tagName.toLowerCase()){var i=o.getAttribute("type");if(null==i||["text","password","number","email","search","tel","url"].includes(i))return}t.prototype.onMouseDown.call(this,e,n,r)},n.prototype.dispose=function(){u(this.cell.id),this.unmountReactComponent()},function(t,e,n,r){var o,i=arguments.length,c=i<3?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)c=Reflect.decorate(t,e,n,r);else for(var a=t.length-1;a>=0;a--)(o=t[a])&&(c=(i<3?o(c):i>3?o(e,n,c):o(e,n))||c);i>3&&c&&Object.defineProperty(e,n,c)}([e.NodeView.dispose()],n.prototype,"dispose",null),n}(e.NodeView);return l.config({bootstrap:[v],actions:{component:v}}),e.NodeView.registry.register(t,l,!0),{Portal:function(){var t=n.useState([]),e=t[0],c=t[1],u=n.useState(),p=u[0],l=u[1],f=n.useRef([]),s=n.useRef([]);a.current=l;var d=n.useCallback((function(t){var e=t.id;if(f.current.includes(e)){var n=s.current,r=n.findIndex((function(t){return t.id===e}));r>-1?n[r]=t:n.push(t),s.current=n}else c((function(n){var r=m([],n,!0),o=r.findIndex((function(t){return t.id===e}));return o>-1?r[o]=t:r.push(t),r}))}),[]);r=d;var h=n.useCallback((function(t){f.current.includes(t)&&(f.current=f.current.filter((function(e){return e!==t}))),s.current.map((function(t){return t.id})).includes(t)&&(s.current=s.current.filter((function(e){return e.id!==t}))),c((function(e){return e.filter((function(e){return e.id!==t}))}))}),[]);o=h;var y=n.useCallback((function(t){var e=t.name,n=(t.data||{}).cells;if("add"===e){var r=(void 0===n?[]:n).filter((function(t){return t.isNode()})).map((function(t){return t.id}));f.current=Array.from(new Set(m(m([],f.current,!0),r,!0)))}}),[]),g=n.useCallback((function(t){if("add"===t.name){var e=s.current;if(e.length){var n=e.map((function(t){return t.id}));f.current=f.current.filter((function(t){return!n.includes(t)})),s.current=[],c((function(t){var n=m([],t,!0);return e.forEach((function(t){var e=n.findIndex((function(e){return e.id===t.id}));e>-1?n[e]=t:n.push(t)})),n}))}}}),[]);return n.useLayoutEffect((function(){return p&&(p.on("batch:start",y),p.on("batch:stop",g)),function(){p&&(p.off("batch:start",y),p.off("batch:stop",g),c([]),f.current=[],s.current=[])}}),[p,y,g]),i.default.createElement.apply(i.default,m([i.default.Fragment,null],e.map((function(t){return t.portal})),!1))},setGraph:function(t){a.current(t)}}}t.createPortal=C,t.registry=a,t.usePortal=function(t){var e=n.useRef(!1),r=n.useState((function(){return e.current?{}:(e.current=!0,C(t))}))[0];return[r.Portal,r.setGraph]},Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=x6-react-shape.js.map
