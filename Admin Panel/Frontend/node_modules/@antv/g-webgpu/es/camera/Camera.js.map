{"version":3,"sources":["../../src/camera/Camera.ts"],"names":["Frustum","IDENTIFIER","mat3","mat4","quat","vec3","vec4","inject","injectable","createVec3","getAngle","Landmark","CAMERA_TYPE","CAMERA_TRACKING_MODE","CAMERA_PROJECTION_MODE","DEG_2_RAD","Math","PI","RAD_2_DEG","Camera","InteractorService","matrix","create","right","fromValues","up","forward","position","focalPoint","distanceVector","distance","azimuth","elevation","roll","relAzimuth","relElevation","relRoll","dollyingStep","maxDistance","Infinity","minDistance","rotateWorld","fov","near","far","aspect","left","rright","top","bottom","zoom","perspective","view","following","undefined","type","EXPLORING","trackingMode","DEFAULT","projectionMode","PERSPECTIVE","frustum","landmarks","landmarkAnimationID","camera","setType","interactor","setWorldRotation","_getAngles","TRACKING","setTrackingMode","Error","flag","invert","_update","setPerspective","fullWidth","fullHeight","x","y","width","height","enabled","offsetX","offsetY","setOrthographic","l","r","t","b","ORTHOGRAPHIC","dx","dy","cx","cy","scaleW","scaleH","ortho","z","_setPosition","setFocalPoint","CINEMATIC","d","subtract","length","el","asin","az","atan2","m","rotateY","rotateX","transformMat4","lookAt","_getAxes","_getDistance","pos","n","f","setAzimuth","setElevation","rl","setRoll","computeMatrix","ORBITING","_getPosition","_getFocalPoint","angle","rotX","setAxisAngle","rotY","rotZ","rotQ","multiply","rotMatrix","fromQuat","translate","abs","tx","ty","coords","clone","add","scale","value","step","updatedDistance","max","min","name","params","setPosition","landmark","push","duration","find","retrieve","window","cancelAnimationFrame","disconnect","destPosition","getPosition","destFocalPoint","getFocalPoint","destRoll","getRoll","timeStart","animate","timestamp","elapsed","cos","interFocalPoint","interPosition","interRoll","lerp","dist","connect","requestAnimationFrame","identity","copy","normalize","transformMat3","fromMat4","ProjectionMode"],"mappings":"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","sourcesContent":["import {\n  Frustum,\n  ICamera,\n  IDENTIFIER,\n  IInteractorService,\n} from '@antv/g-webgpu-core';\nimport { mat3, mat4, quat, vec3, vec4 } from 'gl-matrix';\nimport { inject, injectable, postConstruct } from 'inversify';\nimport { createVec3, getAngle } from '../utils/math';\nimport Landmark from './Landmark';\n\nexport enum CAMERA_TYPE {\n  ORBITING = 'ORBITING',\n  EXPLORING = 'EXPLORING',\n  TRACKING = 'TRACKING',\n}\n\nexport enum CAMERA_TRACKING_MODE {\n  DEFAULT = 'DEFAULT',\n  ROTATIONAL = 'ROTATIONAL',\n  TRANSLATIONAL = 'TRANSLATIONAL',\n  CINEMATIC = 'CINEMATIC',\n}\n\nexport enum CAMERA_PROJECTION_MODE {\n  ORTHOGRAPHIC = 'ORTHOGRAPHIC',\n  PERSPECTIVE = 'PERSPECTIVE',\n}\n\nconst DEG_2_RAD = Math.PI / 180;\nconst RAD_2_DEG = 180 / Math.PI;\n\n/**\n * 参考「WebGL Insights - 23.Designing Cameras for WebGL Applications」，基于 Responsible Camera 思路设计\n * 保存相机参数，定义相机动作：\n * 1. dolly 沿 n 轴移动\n * 2. pan 沿 u v 轴移动\n * 3. rotate 以方位角旋转\n * 4. 移动到 Landmark，具有平滑的动画效果，其间禁止其他用户交互\n */\n@injectable()\nexport class Camera implements ICamera {\n  public static ProjectionMode = {\n    ORTHOGRAPHIC: 'ORTHOGRAPHIC',\n    PERSPECTIVE: 'PERSPECTIVE',\n  };\n  /**\n   * 相机矩阵\n   */\n  public matrix = mat4.create();\n\n  /**\n   * u 轴\n   * @see http://learnwebgl.brown37.net/07_cameras/camera_introduction.html#a-camera-definition\n   */\n  public right = vec3.fromValues(1, 0, 0);\n\n  /**\n   * v 轴\n   */\n  public up = vec3.fromValues(0, 1, 0);\n\n  /**\n   * n 轴\n   */\n  public forward = vec3.fromValues(0, 0, 1);\n\n  /**\n   * 相机位置\n   */\n  public position = vec3.fromValues(0, 0, 1);\n\n  /**\n   * 视点位置\n   */\n  public focalPoint = vec3.fromValues(0, 0, 0);\n\n  /**\n   * 相机位置到视点向量\n   * focalPoint - position\n   */\n  public distanceVector = vec3.fromValues(0, 0, 0);\n\n  /**\n   * 相机位置到视点距离\n   * length(focalPoint - position)\n   */\n  public distance = 1;\n\n  /**\n   * @see https://en.wikipedia.org/wiki/Azimuth\n   */\n  public azimuth = 0;\n  public elevation = 0;\n  public roll = 0;\n  public relAzimuth = 0;\n  public relElevation = 0;\n  public relRoll = 0;\n\n  /**\n   * 沿 n 轴移动时，保证移动速度从快到慢\n   */\n  public dollyingStep = 0;\n  public maxDistance = Infinity;\n  public minDistance = -Infinity;\n\n  /**\n   * invert the horizontal coordinate system HCS\n   */\n  public rotateWorld = false;\n\n  @inject(IDENTIFIER.InteractorService)\n  public interactor: IInteractorService;\n\n  /**\n   * 投影矩阵参数\n   */\n\n  /**\n   * field of view [0-360]\n   * @see http://en.wikipedia.org/wiki/Angle_of_view\n   */\n  private fov = 30;\n  private near = 0.1;\n  private far = 10000;\n  private aspect = 1;\n  private left: number;\n  private rright: number;\n  private top: number;\n  private bottom: number;\n  private zoom = 1;\n  private perspective = mat4.create();\n\n  private view:\n    | {\n        enabled: boolean;\n        fullWidth: number;\n        fullHeight: number;\n        offsetX: number;\n        offsetY: number;\n        width: number;\n        height: number;\n      }\n    | undefined;\n\n  private following = undefined;\n\n  private type = CAMERA_TYPE.EXPLORING;\n  private trackingMode = CAMERA_TRACKING_MODE.DEFAULT;\n  private projectionMode = CAMERA_PROJECTION_MODE.PERSPECTIVE;\n\n  /**\n   * for culling use\n   */\n  private frustum: Frustum = new Frustum();\n\n  /**\n   * switch between multiple landmarks\n   */\n  private landmarks: Landmark[] = [];\n  private landmarkAnimationID: number | undefined;\n\n  public clone(): Camera {\n    const camera = new Camera();\n    camera.setType(this.type, undefined);\n    camera.interactor = this.interactor;\n    return camera;\n  }\n\n  public getProjectionMode() {\n    return this.projectionMode;\n  }\n\n  public getPerspective() {\n    return this.perspective;\n  }\n\n  public getFrustum() {\n    return this.frustum;\n  }\n\n  public getPosition() {\n    return this.position;\n  }\n\n  public setType(\n    type: CAMERA_TYPE,\n    trackingMode: CAMERA_TRACKING_MODE | undefined,\n  ) {\n    this.type = type;\n    if (this.type === CAMERA_TYPE.EXPLORING) {\n      this.setWorldRotation(true);\n    } else {\n      this.setWorldRotation(false);\n    }\n    this._getAngles();\n\n    if (this.type === CAMERA_TYPE.TRACKING && trackingMode !== undefined) {\n      this.setTrackingMode(trackingMode);\n    }\n    return this;\n  }\n\n  public setProjectionMode(projectionMode: CAMERA_PROJECTION_MODE) {\n    this.projectionMode = projectionMode;\n    return this;\n  }\n\n  public setTrackingMode(trackingMode: CAMERA_TRACKING_MODE) {\n    if (this.type !== CAMERA_TYPE.TRACKING) {\n      throw new Error(\n        'Impossible to set a tracking mode if the camera is not of tracking type',\n      );\n    }\n    this.trackingMode = trackingMode;\n    return this;\n  }\n\n  /**\n   * If flag is true, it reverses the azimuth and elevation angles.\n   * Subsequent calls to rotate, setAzimuth, setElevation,\n   * changeAzimuth or changeElevation will cause the inverted effect.\n   * setRoll or changeRoll is not affected by this method.\n   *\n   * This inversion is useful when one wants to simulate that the world\n   * is moving, instead of the camera.\n   *\n   * By default the camera angles are not reversed.\n   * @param {Boolean} flag the boolean flag to reverse the angles.\n   */\n  public setWorldRotation(flag: boolean) {\n    this.rotateWorld = flag;\n    this._getAngles();\n  }\n\n  /**\n   * 计算 MV 矩阵，为相机矩阵的逆矩阵\n   */\n  public getViewTransform(): mat4 {\n    return mat4.invert(mat4.create(), this.matrix)!;\n  }\n\n  public getWorldTransform(): mat4 {\n    return this.matrix;\n  }\n\n  /**\n   * 设置相机矩阵\n   */\n  public setMatrix(matrix: mat4) {\n    this.matrix = matrix;\n    this._update();\n    return this;\n  }\n\n  public setAspect(aspect: number) {\n    this.setPerspective(this.near, this.far, this.fov, aspect);\n    return this;\n  }\n\n  /**\n   * Sets an offset in a larger frustum, used in PixelPicking\n   */\n  public setViewOffset(\n    fullWidth: number,\n    fullHeight: number,\n    x: number,\n    y: number,\n    width: number,\n    height: number,\n  ) {\n    this.aspect = fullWidth / fullHeight;\n    if (this.view === undefined) {\n      this.view = {\n        enabled: true,\n        fullWidth: 1,\n        fullHeight: 1,\n        offsetX: 0,\n        offsetY: 0,\n        width: 1,\n        height: 1,\n      };\n    }\n\n    this.view.enabled = true;\n    this.view.fullWidth = fullWidth;\n    this.view.fullHeight = fullHeight;\n    this.view.offsetX = x;\n    this.view.offsetY = y;\n    this.view.width = width;\n    this.view.height = height;\n\n    if (this.projectionMode === CAMERA_PROJECTION_MODE.PERSPECTIVE) {\n      this.setPerspective(this.near, this.far, this.fov, this.aspect);\n    } else {\n      this.setOrthographic(\n        this.left,\n        this.rright,\n        this.top,\n        this.bottom,\n        this.near,\n        this.far,\n      );\n    }\n    return this;\n  }\n\n  public clearViewOffset() {\n    if (this.view !== undefined) {\n      this.view.enabled = false;\n    }\n\n    if (this.projectionMode === CAMERA_PROJECTION_MODE.PERSPECTIVE) {\n      this.setPerspective(this.near, this.far, this.fov, this.aspect);\n    } else {\n      this.setOrthographic(\n        this.left,\n        this.rright,\n        this.top,\n        this.bottom,\n        this.near,\n        this.far,\n      );\n    }\n    return this;\n  }\n\n  public setPerspective(\n    near: number,\n    far: number,\n    fov: number,\n    aspect: number,\n  ) {\n    this.projectionMode = CAMERA_PROJECTION_MODE.PERSPECTIVE;\n    this.fov = fov;\n    this.near = near;\n    this.far = far;\n    this.aspect = aspect;\n    mat4.perspective(\n      this.perspective,\n      this.fov * DEG_2_RAD,\n      this.aspect,\n      this.near,\n      this.far,\n    );\n    return this;\n  }\n\n  public setOrthographic(\n    l: number,\n    r: number,\n    t: number,\n    b: number,\n    near: number,\n    far: number,\n  ) {\n    this.projectionMode = CAMERA_PROJECTION_MODE.ORTHOGRAPHIC;\n    this.rright = r;\n    this.left = l;\n    this.top = t;\n    this.bottom = b;\n    this.near = near;\n    this.far = far;\n\n    const dx = (this.rright - this.left) / (2 * this.zoom);\n    const dy = (this.top - this.bottom) / (2 * this.zoom);\n    const cx = (this.rright + this.left) / 2;\n    const cy = (this.top + this.bottom) / 2;\n\n    let left = cx - dx;\n    let right = cx + dx;\n    let top = cy + dy;\n    let bottom = cy - dy;\n\n    if (this.view !== undefined && this.view.enabled) {\n      const scaleW =\n        (this.rright - this.left) / this.view.fullWidth / this.zoom;\n      const scaleH =\n        (this.top - this.bottom) / this.view.fullHeight / this.zoom;\n\n      left += scaleW * this.view.offsetX;\n      right = left + scaleW * this.view.width;\n      top -= scaleH * this.view.offsetY;\n      bottom = top - scaleH * this.view.height;\n    }\n\n    mat4.ortho(this.perspective, left, right, top, bottom, near, far);\n    return this;\n  }\n\n  /**\n   * 设置相机位置\n   */\n  public setPosition(x: number | vec3, y?: number, z?: number) {\n    this._setPosition(x, y, z);\n    this.setFocalPoint(this.focalPoint);\n    return this;\n  }\n\n  /**\n   * 设置视点位置\n   */\n  public setFocalPoint(x: number | vec3, y?: number, z?: number) {\n    let up = vec3.fromValues(0, 1, 0);\n    this.focalPoint = createVec3(x, y, z);\n\n    if (this.trackingMode === CAMERA_TRACKING_MODE.CINEMATIC) {\n      const d = vec3.subtract(vec3.create(), this.focalPoint, this.position);\n      x = d[0];\n      y = d[1] as number;\n      z = d[2] as number;\n      const r = vec3.length(d);\n      const el = Math.asin(y / r) * RAD_2_DEG;\n      const az = 90 + Math.atan2(z, x) * RAD_2_DEG;\n      const m = mat4.create();\n      mat4.rotateY(m, m, az * DEG_2_RAD);\n      mat4.rotateX(m, m, el * DEG_2_RAD);\n      up = vec3.transformMat4(vec3.create(), [0, 1, 0], m);\n    }\n\n    mat4.invert(\n      this.matrix,\n      mat4.lookAt(mat4.create(), this.position, this.focalPoint, up),\n    );\n\n    this._getAxes();\n    this._getDistance();\n    this._getAngles();\n    return this;\n  }\n\n  /**\n   * 固定当前视点，按指定距离放置相机\n   */\n  public setDistance(d: number) {\n    if (this.distance === d || d < 0) {\n      return;\n    }\n\n    this.distance = d;\n\n    if (this.distance < 0.0002) {\n      this.distance = 0.0002;\n    }\n    this.dollyingStep = this.distance / 100;\n\n    const pos = vec3.create();\n    d = this.distance;\n    const n = this.forward;\n    const f = this.focalPoint;\n\n    pos[0] = d * n[0] + f[0];\n    pos[1] = d * n[1] + f[1];\n    pos[2] = d * n[2] + f[2];\n\n    this._setPosition(pos);\n    return this;\n  }\n\n  public setMaxDistance(d: number) {\n    this.maxDistance = d;\n    return this;\n  }\n\n  public setMinDistance(d: number) {\n    this.minDistance = d;\n    return this;\n  }\n\n  /**\n   * Changes the initial azimuth of the camera\n   */\n  public changeAzimuth(az: number) {\n    this.setAzimuth(this.azimuth + az);\n    return this;\n  }\n\n  /**\n   * Changes the initial elevation of the camera\n   */\n  public changeElevation(el: number) {\n    this.setElevation(this.elevation + el);\n    return this;\n  }\n\n  /**\n   * Changes the initial roll of the camera\n   */\n  public changeRoll(rl: number) {\n    this.setRoll(this.roll + rl);\n    return this;\n  }\n\n  /**\n   * 设置相机方位角，不同相机模式下需要重新计算相机位置或者是视点位置\n   * @param {Number} el the azimuth in degrees\n   */\n  public setAzimuth(az: number) {\n    this.azimuth = getAngle(az);\n    this.computeMatrix();\n\n    this._getAxes();\n    if (\n      this.type === CAMERA_TYPE.ORBITING ||\n      this.type === CAMERA_TYPE.EXPLORING\n    ) {\n      this._getPosition();\n    } else if (this.type === CAMERA_TYPE.TRACKING) {\n      this._getFocalPoint();\n    }\n    return this;\n  }\n\n  public getAzimuth() {\n    return this.azimuth;\n  }\n\n  /**\n   * 设置相机方位角，不同相机模式下需要重新计算相机位置或者是视点位置\n   * @param {Number} el the elevation in degrees\n   */\n  public setElevation(el: number) {\n    this.elevation = getAngle(el);\n    this.computeMatrix();\n\n    this._getAxes();\n    if (\n      this.type === CAMERA_TYPE.ORBITING ||\n      this.type === CAMERA_TYPE.EXPLORING\n    ) {\n      this._getPosition();\n    } else if (this.type === CAMERA_TYPE.TRACKING) {\n      this._getFocalPoint();\n    }\n    return this;\n  }\n\n  /**\n   * 设置相机方位角，不同相机模式下需要重新计算相机位置或者是视点位置\n   * @param {Number} angle the roll angle\n   */\n  public setRoll(angle: number) {\n    this.roll = getAngle(angle);\n    this.computeMatrix();\n\n    this._getAxes();\n    if (\n      this.type === CAMERA_TYPE.ORBITING ||\n      this.type === CAMERA_TYPE.EXPLORING\n    ) {\n      this._getPosition();\n    } else if (this.type === CAMERA_TYPE.TRACKING) {\n      this._getFocalPoint();\n    }\n    return this;\n  }\n\n  /**\n   * Changes the azimuth and elevation with respect to the current camera axes\n   * @param {Number} azimuth the relative azimuth\n   * @param {Number} elevation the relative elevation\n   * @param {Number} roll the relative roll\n   */\n  public rotate(azimuth: number, elevation: number, roll: number) {\n    if (this.type === CAMERA_TYPE.EXPLORING) {\n      azimuth = getAngle(azimuth);\n      elevation = getAngle(elevation);\n      roll = getAngle(roll);\n\n      const rotX = quat.setAxisAngle(\n        quat.create(),\n        [1, 0, 0],\n        (this.rotateWorld ? 1 : -1) * elevation * DEG_2_RAD,\n      );\n      const rotY = quat.setAxisAngle(\n        quat.create(),\n        [0, 1, 0],\n        (this.rotateWorld ? 1 : -1) * azimuth * DEG_2_RAD,\n      );\n\n      const rotZ = quat.setAxisAngle(\n        quat.create(),\n        [0, 0, 1],\n        roll * DEG_2_RAD,\n      );\n      let rotQ = quat.multiply(quat.create(), rotY, rotX);\n      rotQ = quat.multiply(quat.create(), rotQ, rotZ);\n      const rotMatrix = mat4.fromQuat(mat4.create(), rotQ);\n      mat4.translate(this.matrix, this.matrix, [0, 0, -this.distance]);\n      mat4.multiply(this.matrix, this.matrix, rotMatrix);\n      mat4.translate(this.matrix, this.matrix, [0, 0, this.distance]);\n    } else {\n      if (Math.abs(this.elevation + elevation) > 90) {\n        return;\n      }\n      this.relElevation = getAngle(elevation);\n      this.relAzimuth = getAngle(azimuth);\n      this.relRoll = getAngle(roll);\n      this.elevation += this.relElevation;\n      this.azimuth += this.relAzimuth;\n      this.roll += this.relRoll;\n\n      this.computeMatrix();\n    }\n\n    this._getAxes();\n    if (\n      this.type === CAMERA_TYPE.ORBITING ||\n      this.type === CAMERA_TYPE.EXPLORING\n    ) {\n      this._getPosition();\n    } else if (this.type === CAMERA_TYPE.TRACKING) {\n      this._getFocalPoint();\n    }\n\n    this._update();\n    return this;\n  }\n\n  /**\n   * 沿水平(right) & 垂直(up)平移相机\n   */\n  public pan(tx: number, ty: number) {\n    const coords = createVec3(tx, ty, 0);\n    const pos = vec3.clone(this.position);\n\n    vec3.add(pos, pos, vec3.scale(vec3.create(), this.right, coords[0]));\n    vec3.add(pos, pos, vec3.scale(vec3.create(), this.up, coords[1]));\n\n    this._setPosition(pos);\n\n    return this;\n  }\n\n  /**\n   * 沿 n 轴移动，当距离视点远时移动速度较快，离视点越近速度越慢\n   */\n  public dolly(value: number) {\n    const n = this.forward;\n    const pos = vec3.clone(this.position);\n    let step = value * this.dollyingStep;\n    const updatedDistance = this.distance + value * this.dollyingStep;\n\n    // 限制视点距离范围\n    step =\n      Math.max(Math.min(updatedDistance, this.maxDistance), this.minDistance) -\n      this.distance;\n    pos[0] += step * n[0];\n    pos[1] += step * n[1];\n    pos[2] += step * n[2];\n\n    this._setPosition(pos);\n    if (\n      this.type === CAMERA_TYPE.ORBITING ||\n      this.type === CAMERA_TYPE.EXPLORING\n    ) {\n      // 重新计算视点距离\n      this._getDistance();\n    } else if (this.type === CAMERA_TYPE.TRACKING) {\n      // 保持视距，移动视点位置\n      vec3.add(this.focalPoint, pos, this.distanceVector);\n    }\n    return this;\n  }\n\n  public createLandmark(\n    name: string,\n    params: {\n      position: vec3;\n      focalPoint: vec3;\n      roll?: number;\n    },\n  ): Landmark {\n    const camera = this.clone();\n    camera.setPosition(params.position);\n    camera.setFocalPoint(params.focalPoint);\n    if (params.roll !== undefined) {\n      camera.setRoll(params.roll);\n    }\n    const landmark = new Landmark(name, camera);\n    this.landmarks.push(landmark);\n    return landmark;\n  }\n\n  public setLandmark(name: string) {\n    const landmark = new Landmark(name, this);\n    this.landmarks.push(landmark);\n    return this;\n  }\n\n  public gotoLandmark(name: string, duration: number = 1000) {\n    const landmark = this.landmarks.find((l) => l.name === name);\n    if (landmark) {\n      if (duration === 0) {\n        landmark.retrieve(this);\n        return;\n      }\n\n      if (this.landmarkAnimationID !== undefined) {\n        window.cancelAnimationFrame(this.landmarkAnimationID);\n      }\n\n      // TODO: do not process events during animation\n      this.interactor.disconnect();\n\n      const destPosition = landmark.getPosition();\n      const destFocalPoint = landmark.getFocalPoint();\n      const destRoll = landmark.getRoll();\n\n      let timeStart: number | undefined;\n      const animate = (timestamp: number) => {\n        if (timeStart === undefined) {\n          timeStart = timestamp;\n        }\n        const elapsed = timestamp - timeStart;\n        // TODO: use better ease function\n        const t = (1 - Math.cos((elapsed / duration) * Math.PI)) / 2;\n\n        const interFocalPoint = vec3.create();\n        const interPosition = vec3.create();\n        let interRoll = 0;\n\n        vec3.lerp(interFocalPoint, this.focalPoint, destFocalPoint, t);\n        vec3.lerp(interPosition, this.position, destPosition, t);\n        interRoll = this.roll * (1 - t) + destRoll * t;\n\n        this.setFocalPoint(interFocalPoint);\n        this.setPosition(interPosition);\n        this.setRoll(interRoll);\n        this.computeMatrix();\n\n        const dist =\n          vec3.dist(interFocalPoint, destFocalPoint) +\n          vec3.dist(interPosition, destPosition);\n        if (dist > 0.01) {\n          //\n        } else {\n          this.setFocalPoint(interFocalPoint);\n          this.setPosition(interPosition);\n          this.setRoll(interRoll);\n          this.computeMatrix();\n          this.interactor.connect();\n          return;\n        }\n\n        if (elapsed < duration) {\n          this.landmarkAnimationID = window.requestAnimationFrame(animate);\n        }\n      };\n\n      window.requestAnimationFrame(animate);\n    }\n  }\n\n  /**\n   * 根据相机矩阵重新计算各种相机参数\n   */\n  private _update() {\n    this._getAxes();\n    this._getPosition();\n    this._getDistance();\n    this._getAngles();\n  }\n\n  /**\n   * 计算相机矩阵\n   */\n  private computeMatrix() {\n    let rotX;\n    let rotY;\n    // 使用四元数描述 3D 旋转\n    // @see https://xiaoiver.github.io/coding/2018/12/28/Camera-%E8%AE%BE%E8%AE%A1-%E4%B8%80.html\n    const rotZ = quat.setAxisAngle(\n      quat.create(),\n      [0, 0, 1],\n      this.roll * DEG_2_RAD,\n    );\n\n    mat4.identity(this.matrix);\n\n    // only consider HCS for EXPLORING and ORBITING cameras\n    rotX = quat.setAxisAngle(\n      quat.create(),\n      [1, 0, 0],\n      ((this.rotateWorld && this.type !== CAMERA_TYPE.TRACKING) ||\n      this.type === CAMERA_TYPE.TRACKING\n        ? 1\n        : -1) *\n        this.elevation *\n        DEG_2_RAD,\n    );\n    rotY = quat.setAxisAngle(\n      quat.create(),\n      [0, 1, 0],\n      ((this.rotateWorld && this.type !== CAMERA_TYPE.TRACKING) ||\n      this.type === CAMERA_TYPE.TRACKING\n        ? 1\n        : -1) *\n        this.azimuth *\n        DEG_2_RAD,\n    );\n\n    let rotQ = quat.multiply(quat.create(), rotY, rotX);\n    rotQ = quat.multiply(quat.create(), rotQ, rotZ);\n    const rotMatrix = mat4.fromQuat(mat4.create(), rotQ);\n\n    if (\n      this.type === CAMERA_TYPE.ORBITING ||\n      this.type === CAMERA_TYPE.EXPLORING\n    ) {\n      mat4.translate(this.matrix, this.matrix, this.focalPoint);\n      mat4.multiply(this.matrix, this.matrix, rotMatrix);\n      mat4.translate(this.matrix, this.matrix, [0, 0, this.distance]);\n    } else if (this.type === CAMERA_TYPE.TRACKING) {\n      mat4.translate(this.matrix, this.matrix, this.position);\n      mat4.multiply(this.matrix, this.matrix, rotMatrix);\n    }\n  }\n\n  /**\n   * Sets the camera position in the camera matrix\n   */\n  private _setPosition(x: number | vec3, y?: number, z?: number) {\n    this.position = createVec3(x, y, z);\n    const m = this.matrix;\n    m[12] = this.position[0];\n    m[13] = this.position[1];\n    m[14] = this.position[2];\n    m[15] = 1;\n  }\n\n  /**\n   * Recalculates axes based on the current matrix\n   */\n  private _getAxes() {\n    vec3.copy(\n      this.right,\n      createVec3(vec4.transformMat4(vec4.create(), [1, 0, 0, 0], this.matrix)),\n    );\n    vec3.copy(\n      this.up,\n      createVec3(vec4.transformMat4(vec4.create(), [0, 1, 0, 0], this.matrix)),\n    );\n    vec3.copy(\n      this.forward,\n      createVec3(vec4.transformMat4(vec4.create(), [0, 0, 1, 0], this.matrix)),\n    );\n    vec3.normalize(this.right, this.right);\n    vec3.normalize(this.up, this.up);\n    vec3.normalize(this.forward, this.forward);\n  }\n\n  /**\n   * Recalculates euler angles based on the current state\n   */\n  private _getAngles() {\n    // Recalculates angles\n    const x = this.distanceVector[0];\n    const y = this.distanceVector[1];\n    const z = this.distanceVector[2];\n    const r = vec3.length(this.distanceVector);\n\n    // FAST FAIL: If there is no distance we cannot compute angles\n    if (r === 0) {\n      this.elevation = 0;\n      this.azimuth = 0;\n      return;\n    }\n\n    if (this.type === CAMERA_TYPE.TRACKING) {\n      this.elevation = Math.asin(y / r) * RAD_2_DEG;\n      this.azimuth = Math.atan2(-x, -z) * RAD_2_DEG;\n    } else {\n      if (this.rotateWorld) {\n        this.elevation = Math.asin(y / r) * RAD_2_DEG;\n        this.azimuth = Math.atan2(-x, -z) * RAD_2_DEG;\n      } else {\n        this.elevation = -Math.asin(y / r) * RAD_2_DEG;\n        this.azimuth = -Math.atan2(-x, -z) * RAD_2_DEG;\n      }\n    }\n  }\n\n  /**\n   * 重新计算相机位置，只有 ORBITING 模式相机位置才会发生变化\n   */\n  private _getPosition() {\n    vec3.copy(\n      this.position,\n      createVec3(vec4.transformMat4(vec4.create(), [0, 0, 0, 1], this.matrix)),\n    );\n\n    // 相机位置变化，需要重新计算视距\n    this._getDistance();\n  }\n\n  /**\n   * 重新计算视点，只有 TRACKING 模式视点才会发生变化\n   */\n  private _getFocalPoint() {\n    vec3.transformMat3(\n      this.distanceVector,\n      [0, 0, -this.distance],\n      mat3.fromMat4(mat3.create(), this.matrix),\n    );\n    vec3.add(this.focalPoint, this.position, this.distanceVector);\n\n    // 视点变化，需要重新计算视距\n    this._getDistance();\n  }\n\n  /**\n   * 重新计算视距\n   */\n  private _getDistance() {\n    this.distanceVector = vec3.subtract(\n      vec3.create(),\n      this.focalPoint,\n      this.position,\n    );\n    this.distance = vec3.length(this.distanceVector);\n    this.dollyingStep = this.distance / 100;\n  }\n}\n"],"file":"Camera.js"}