{"version":3,"sources":["../../src/geometry/Merged.ts"],"names":["Merged","config","geometries","mergedComponent","getComponent","aabb","AABB","mergedAttributes","mergedIndices","indexOffset","forEach","geometry","indices","vertexCount","attributes","add","push","map","index","attribute","i","dirty","data","concat","Uint32Array","from","Geometry"],"mappings":";;;;;;;;;;;;;;;;;;;;;AAAA;;AACA;;AACA;;AACA;;AACA;;AACA;;;;;;;;;AAOA;AACA;AACA;AACaA,M,WAJZ,4B;;;;;;;;;;;;sCAK6B;AAAA,kCACE,KAAKC,MADP,CAClBC,UADkB;AAAA,UAClBA,UADkB,sCACL,EADK;AAG1B,UAAMC,eAAe,GAAG,KAAKC,YAAL,EAAxB;AACAD,MAAAA,eAAe,CAACE,IAAhB,GAAuB,IAAIC,iBAAJ,EAAvB;AAEA,UAAMC,gBAAiD,GAAG,EAA1D;AACA,UAAMC,aAAuB,GAAG,EAAhC;AACA,UAAIC,WAAW,GAAG,CAAlB;AACAP,MAAAA,UAAU,CAACQ,OAAX,CAAmB,UAACC,QAAD,EAAc;AAAA,YACvBN,IADuB,GACoBM,QADpB,CACvBN,IADuB;AAAA,YACjBO,OADiB,GACoBD,QADpB,CACjBC,OADiB;AAAA,YACRC,WADQ,GACoBF,QADpB,CACRE,WADQ;AAAA,YACKC,UADL,GACoBH,QADpB,CACKG,UADL,EAG/B;;AACAX,QAAAA,eAAe,CAACE,IAAhB,CAAqBU,GAArB,CAAyBV,IAAzB;AACAF,QAAAA,eAAe,CAACU,WAAhB,IAA+BA,WAA/B,CAL+B,CAO/B;;AACA,YAAID,OAAJ,EAAa;AACXJ,UAAAA,aAAa,CAACQ,IAAd,OAAAR,aAAa,mCAASI,OAAO,CAACK,GAAR,CAAY,UAACC,KAAD;AAAA,mBAAWA,KAAK,GAAGT,WAAnB;AAAA,WAAZ,CAAT,EAAb;AACD;;AACDA,QAAAA,WAAW,IAAII,WAAf,CAX+B,CAa/B;;AACAC,QAAAA,UAAU,CAACJ,OAAX,CAAmB,UAACS,SAAD,EAAYC,CAAZ,EAAkB;AACnC,cAAI,CAACb,gBAAgB,CAACa,CAAD,CAArB,EAA0B;AACxBb,YAAAA,gBAAgB,CAACa,CAAD,CAAhB,GAAsBD,SAAtB;AACAZ,YAAAA,gBAAgB,CAACa,CAAD,CAAhB,CAAoBC,KAApB,GAA4B,IAA5B;AACD,WAHD,MAGO;AACL,gBAAIF,SAAS,CAACG,IAAd,EAAoB;AAClB,kBAAI,wBAASH,SAAS,CAACG,IAAnB,CAAJ,EAA8B;AAC5B;AACAf,gBAAAA,gBAAgB,CAACa,CAAD,CAAhB,CAAoBJ,IAApB,CAAyBG,SAAS,CAACG,IAAnC;AACD,eAHD,MAGO,IAAI,gCAAaH,SAAS,CAACG,IAAvB,CAAJ,EAAkC;AACvC;AACAf,gBAAAA,gBAAgB,CAACa,CAAD,CAAhB,CAAoBE,IAApB,GAA2B,wBACzB;AACAf,gBAAAA,gBAAgB,CAACa,CAAD,CAAhB,CAAoBE,IAFK,EAGzBH,SAAS,CAACG,IAHe,CAA3B;AAKD,eAPM,MAOA;AACL;AACAf,gBAAAA,gBAAgB,CAACa,CAAD,CAAhB,CAAoBE,IAApB,GAA2Bf,gBAAgB,CAACa,CAAD,CAAhB,CAAoBE,IAApB,CAAyBC,MAAzB,CACzBJ,SAAS,CAACG,IADe,CAA3B;AAGD;AACF;AACF;AACF,SAxBD;AAyBD,OAvCD;AAyCAnB,MAAAA,eAAe,CAACW,UAAhB,GAA6BP,gBAA7B;AACAJ,MAAAA,eAAe,CAACS,OAAhB,GAA0BY,WAAW,CAACC,IAAZ,CAAiBjB,aAAjB,CAA1B;AACAL,MAAAA,eAAe,CAACkB,KAAhB,GAAwB,IAAxB;AACD;;;EAtDyBK,U","sourcesContent":["import { AABB, GeometryComponent } from '@antv/g-webgpu-core';\nimport { injectable } from 'inversify';\nimport { Geometry } from '.';\nimport { isNumber } from '../utils/is-number';\nimport { isTypedArray } from '../utils/is-typedarray';\nimport { merge } from '../utils/typedarray';\n\nexport interface IMergedGeometryParams {\n  geometries: GeometryComponent[];\n}\n\n@injectable()\n/**\n * merge many geometries into one, use a batch of draw calls\n */\nexport class Merged extends Geometry<Partial<IMergedGeometryParams>> {\n  protected onEntityCreated() {\n    const { geometries = [] } = this.config;\n\n    const mergedComponent = this.getComponent();\n    mergedComponent.aabb = new AABB();\n\n    const mergedAttributes: GeometryComponent['attributes'] = [];\n    const mergedIndices: number[] = [];\n    let indexOffset = 0;\n    geometries.forEach((geometry) => {\n      const { aabb, indices, vertexCount, attributes } = geometry;\n\n      // merge aabb\n      mergedComponent.aabb.add(aabb);\n      mergedComponent.vertexCount += vertexCount;\n\n      // merge indices\n      if (indices) {\n        mergedIndices.push(...indices.map((index) => index + indexOffset));\n      }\n      indexOffset += vertexCount;\n\n      // merge attributes\n      attributes.forEach((attribute, i) => {\n        if (!mergedAttributes[i]) {\n          mergedAttributes[i] = attribute;\n          mergedAttributes[i].dirty = true;\n        } else {\n          if (attribute.data) {\n            if (isNumber(attribute.data)) {\n              // @ts-ignore\n              mergedAttributes[i].push(attribute.data);\n            } else if (isTypedArray(attribute.data)) {\n              // @ts-ignore\n              mergedAttributes[i].data = merge(\n                // @ts-ignore\n                mergedAttributes[i].data,\n                attribute.data,\n              );\n            } else {\n              // @ts-ignore\n              mergedAttributes[i].data = mergedAttributes[i].data.concat(\n                attribute.data,\n              );\n            }\n          }\n        }\n      });\n    });\n\n    mergedComponent.attributes = mergedAttributes;\n    mergedComponent.indices = Uint32Array.from(mergedIndices);\n    mergedComponent.dirty = true;\n  }\n}\n"],"file":"Merged.js"}